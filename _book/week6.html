<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>第六周：回归分析初步 – 统计学与R语言</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./week7.html" rel="next">
<link href="./week5.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles/custom.css">
<link rel="stylesheet" href="styles/mermaid.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./week5.html">项目二：商业数据分析与统计推断</a></li><li class="breadcrumb-item"><a href="./week6.html"><span class="chapter-title">第六周：回归分析初步</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">统计学与R语言</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/h-lu/stat2025" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">欢迎</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./syllbus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">课程概述</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">项目一：统计分析基础与数据可视化</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week1.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">第一周：统计学导论</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week2.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">第二周：R语言数据导入与数据初步理解</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week3.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">第三周：描述性统计：数据探索与可视化</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week4.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">第四周：推断性统计初步：参数估计与假设检验</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">项目二：商业数据分析与统计推断</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week5.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">第五周：方差分析</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week6.html" class="sidebar-item-text sidebar-link active"><span class="chapter-title">第六周：回归分析初步</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week7.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">第七周：分类数据分析</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week8.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">第八周：项目二总结与汇报</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#第十一次课线性回归模型与最小二乘法" id="toc-第十一次课线性回归模型与最小二乘法" class="nav-link active" data-scroll-target="#第十一次课线性回归模型与最小二乘法">第十一次课：线性回归模型与最小二乘法</a>
  <ul class="collapse">
  <li><a href="#回归分析概述" id="toc-回归分析概述" class="nav-link" data-scroll-target="#回归分析概述">回归分析概述</a></li>
  <li><a href="#简单线性回归模型" id="toc-简单线性回归模型" class="nav-link" data-scroll-target="#简单线性回归模型">简单线性回归模型</a></li>
  <li><a href="#最小二乘法的数学原理" id="toc-最小二乘法的数学原理" class="nav-link" data-scroll-target="#最小二乘法的数学原理">最小二乘法的数学原理</a></li>
  </ul></li>
  <li><a href="#回归模型的评估指标" id="toc-回归模型的评估指标" class="nav-link" data-scroll-target="#回归模型的评估指标">回归模型的评估指标</a></li>
  <li><a href="#回归系数统计性质" id="toc-回归系数统计性质" class="nav-link" data-scroll-target="#回归系数统计性质">回归系数统计性质</a>
  <ul class="collapse">
  <li><a href="#最小二乘估计的统计性质-高斯-马尔可夫定理" id="toc-最小二乘估计的统计性质-高斯-马尔可夫定理" class="nav-link" data-scroll-target="#最小二乘估计的统计性质-高斯-马尔可夫定理">最小二乘估计的统计性质 (高斯-马尔可夫定理)</a></li>
  <li><a href="#假设检验" id="toc-假设检验" class="nav-link" data-scroll-target="#假设检验">假设检验</a></li>
  <li><a href="#回归假设不满足时的问题及解决方法" id="toc-回归假设不满足时的问题及解决方法" class="nav-link" data-scroll-target="#回归假设不满足时的问题及解决方法">回归假设不满足时的问题及解决方法</a></li>
  <li><a href="#r语言实现简单线性回归" id="toc-r语言实现简单线性回归" class="nav-link" data-scroll-target="#r语言实现简单线性回归">R语言实现简单线性回归</a></li>
  </ul></li>
  <li><a href="#第十二次课多元线性回归模型" id="toc-第十二次课多元线性回归模型" class="nav-link" data-scroll-target="#第十二次课多元线性回归模型">第十二次课：多元线性回归模型</a>
  <ul class="collapse">
  <li><a href="#多元线性回归模型" id="toc-多元线性回归模型" class="nav-link" data-scroll-target="#多元线性回归模型">多元线性回归模型</a></li>
  </ul></li>
  <li><a href="#偏回归系数的解释" id="toc-偏回归系数的解释" class="nav-link" data-scroll-target="#偏回归系数的解释">偏回归系数的解释</a></li>
  <li><a href="#变量选择问题" id="toc-变量选择问题" class="nav-link" data-scroll-target="#变量选择问题">变量选择问题</a></li>
  <li><a href="#变量选择的方法" id="toc-变量选择的方法" class="nav-link" data-scroll-target="#变量选择的方法">变量选择的方法</a></li>
  <li><a href="#变量选择方法的比较" id="toc-变量选择方法的比较" class="nav-link" data-scroll-target="#变量选择方法的比较">变量选择方法的比较</a></li>
  <li><a href="#变量重要性可视化" id="toc-变量重要性可视化" class="nav-link" data-scroll-target="#变量重要性可视化">变量重要性可视化</a></li>
  <li><a href="#变量选择标准" id="toc-变量选择标准" class="nav-link" data-scroll-target="#变量选择标准">变量选择标准</a></li>
  <li><a href="#参考文献与扩展阅读" id="toc-参考文献与扩展阅读" class="nav-link" data-scroll-target="#参考文献与扩展阅读">参考文献与扩展阅读</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./week5.html">项目二：商业数据分析与统计推断</a></li><li class="breadcrumb-item"><a href="./week6.html"><span class="chapter-title">第六周：回归分析初步</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-title">第六周：回归分析初步</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="第十一次课线性回归模型与最小二乘法" class="level2">
<h2 class="anchored" data-anchor-id="第十一次课线性回归模型与最小二乘法">第十一次课：线性回归模型与最小二乘法</h2>
<section id="回归分析概述" class="level3">
<h3 class="anchored" data-anchor-id="回归分析概述">回归分析概述</h3>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
回归分析
</div>
</div>
<div class="callout-body-container callout-body">
<p>回归分析是统计分析中重要的工具，它用于描述变量之间的线性关系，并建立预测模型。</p>
</div>
</div>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
回归分析的目的
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>研究关系</strong>：分析因变量与一个或多个自变量之间的关系。</li>
<li><strong>建立模型</strong>：构建模型以进行预测和解释现象。</li>
<li><strong>评估关联</strong>：评估变量之间关联的程度和方向。</li>
</ul>
<p>回归分析是商业分析中常用的核心技术之一，可以解答以下商业问题：</p>
<ul>
<li>哪些因素关键影响销售额？各自的影响程度如何？</li>
<li>如何通过产品特征预测产品价格？</li>
<li>不同的营销投入对业绩的边际贡献是多少？</li>
</ul>
</div>
</div>
<div class="callout callout-style-simple callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
回归分析的应用场景
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>预测</strong>：销售额预测、房价预测、股票价格预测等。</li>
<li><strong>行为分析</strong>：分析影响消费者购买行为的因素。</li>
<li><strong>效果评估</strong>：评估营销活动、政策实施等效果。</li>
<li><strong>绩效识别</strong>：识别影响企业绩效的关键指标。</li>
</ul>
</div>
</div>
<div class="callout callout-style-simple callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
回归分析的类型
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>按关系类型</strong>
<ul>
<li><strong>线性回归</strong>：自变量与因变量之间呈线性关系。</li>
<li><strong>非线性回归</strong>：自变量与因变量之间呈非线性关系。</li>
</ul></li>
<li><strong>按自变量数量</strong>
<ul>
<li><strong>简单线性回归</strong>：仅有一个自变量。</li>
<li><strong>多元线性回归</strong>：有多个自变量。</li>
</ul></li>
</ul>
</div>
</div>
<div class="callout callout-style-simple callout-important no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
回归分析与其他统计方法的区别
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>与相关分析</strong>：回归分析不仅描述变量间的关系，更侧重于建立预测模型。</li>
<li><strong>与方差分析</strong>：回归分析主要处理连续型自变量，而方差分析侧重于分类自变量。</li>
</ul>
</div>
</div>
<div class="callout callout-style-simple callout-caution no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
回归分析的基本步骤
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><strong>模型确定</strong>：选择合适的回归模型类型 (线性/非线性，简单/多元)。</li>
<li><strong>参数估计</strong>：使用样本数据估计模型中的未知参数。</li>
<li><strong>模型检验</strong>：评估模型的拟合效果和统计显著性。</li>
<li><strong>模型应用</strong>：运用已建立的模型进行预测、解释和决策。</li>
</ol>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载波士顿房价数据集</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Boston)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看数据集结构</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(Boston)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   506 obs. of  14 variables:
 $ crim   : num  0.00632 0.02731 0.02729 0.03237 0.06905 ...
 $ zn     : num  18 0 0 0 0 0 12.5 12.5 12.5 12.5 ...
 $ indus  : num  2.31 7.07 7.07 2.18 2.18 2.18 7.87 7.87 7.87 7.87 ...
 $ chas   : int  0 0 0 0 0 0 0 0 0 0 ...
 $ nox    : num  0.538 0.469 0.469 0.458 0.458 0.458 0.524 0.524 0.524 0.524 ...
 $ rm     : num  6.58 6.42 7.18 7 7.15 ...
 $ age    : num  65.2 78.9 61.1 45.8 54.2 58.7 66.6 96.1 100 85.9 ...
 $ dis    : num  4.09 4.97 4.97 6.06 6.06 ...
 $ rad    : int  1 2 2 3 3 3 5 5 5 5 ...
 $ tax    : num  296 242 242 222 222 222 311 311 311 311 ...
 $ ptratio: num  15.3 17.8 17.8 18.7 18.7 18.7 15.2 15.2 15.2 15.2 ...
 $ black  : num  397 397 393 395 397 ...
 $ lstat  : num  4.98 9.14 4.03 2.94 5.33 ...
 $ medv   : num  24 21.6 34.7 33.4 36.2 28.7 22.9 27.1 16.5 18.9 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 数据集概要</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(Boston)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      crim                zn             indus            chas        
 Min.   : 0.00632   Min.   :  0.00   Min.   : 0.46   Min.   :0.00000  
 1st Qu.: 0.08205   1st Qu.:  0.00   1st Qu.: 5.19   1st Qu.:0.00000  
 Median : 0.25651   Median :  0.00   Median : 9.69   Median :0.00000  
 Mean   : 3.61352   Mean   : 11.36   Mean   :11.14   Mean   :0.06917  
 3rd Qu.: 3.67708   3rd Qu.: 12.50   3rd Qu.:18.10   3rd Qu.:0.00000  
 Max.   :88.97620   Max.   :100.00   Max.   :27.74   Max.   :1.00000  
      nox               rm             age              dis        
 Min.   :0.3850   Min.   :3.561   Min.   :  2.90   Min.   : 1.130  
 1st Qu.:0.4490   1st Qu.:5.886   1st Qu.: 45.02   1st Qu.: 2.100  
 Median :0.5380   Median :6.208   Median : 77.50   Median : 3.207  
 Mean   :0.5547   Mean   :6.285   Mean   : 68.57   Mean   : 3.795  
 3rd Qu.:0.6240   3rd Qu.:6.623   3rd Qu.: 94.08   3rd Qu.: 5.188  
 Max.   :0.8710   Max.   :8.780   Max.   :100.00   Max.   :12.127  
      rad              tax           ptratio          black       
 Min.   : 1.000   Min.   :187.0   Min.   :12.60   Min.   :  0.32  
 1st Qu.: 4.000   1st Qu.:279.0   1st Qu.:17.40   1st Qu.:375.38  
 Median : 5.000   Median :330.0   Median :19.05   Median :391.44  
 Mean   : 9.549   Mean   :408.2   Mean   :18.46   Mean   :356.67  
 3rd Qu.:24.000   3rd Qu.:666.0   3rd Qu.:20.20   3rd Qu.:396.23  
 Max.   :24.000   Max.   :711.0   Max.   :22.00   Max.   :396.90  
     lstat            medv      
 Min.   : 1.73   Min.   : 5.00  
 1st Qu.: 6.95   1st Qu.:17.02  
 Median :11.36   Median :21.20  
 Mean   :12.65   Mean   :22.53  
 3rd Qu.:16.95   3rd Qu.:25.00  
 Max.   :37.97   Max.   :50.00  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 探索性数据分析：房价与几个主要因素之间的关系</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Boston, <span class="fu">aes</span>(<span class="at">x =</span> rm, <span class="at">y =</span> medv)) <span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"房间数与房价关系"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"平均房间数"</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"房价（千美元）"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Boston, <span class="fu">aes</span>(<span class="at">x =</span> lstat, <span class="at">y =</span> medv)) <span class="sc">+</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"低收入人口比例与房价关系"</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"低收入人口比例(%)"</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"房价（千美元）"</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Boston, <span class="fu">aes</span>(<span class="at">x =</span> crim, <span class="at">y =</span> medv)) <span class="sc">+</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"犯罪率与房价关系"</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"犯罪率"</span>,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"房价（千美元）"</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="简单线性回归模型" class="level3">
<h3 class="anchored" data-anchor-id="简单线性回归模型">简单线性回归模型</h3>
<p><strong>模型形式</strong>：<span class="math inline">\(y = \beta_0 + \beta_1 x + \epsilon\)</span></p>
<ul>
<li><span class="math inline">\(y\)</span>：因变量</li>
<li><span class="math inline">\(x\)</span>：自变量</li>
<li><span class="math inline">\(\beta_0\)</span>：截距，当<span class="math inline">\(x=0\)</span>时，<span class="math inline">\(y\)</span>的期望值</li>
<li><span class="math inline">\(\beta_1\)</span>：斜率，自变量<span class="math inline">\(x\)</span>每增加一个单位，因变量<span class="math inline">\(y\)</span>的平均变化量</li>
<li><span class="math inline">\(\epsilon\)</span>：随机误差项，反映模型无法解释的随机变异</li>
</ul>
<p>简单线性回归是理解回归分析的基础，它描述了一个自变量和一个因变量之间的线性关系。例如，我们可以建立一个模型来描述房屋平均房间数（自变量）与房价（因变量）之间的关系。</p>
</section>
<section id="最小二乘法的数学原理" class="level3">
<h3 class="anchored" data-anchor-id="最小二乘法的数学原理">最小二乘法的数学原理</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
最小二乘法 (OLS) 的基本思想
</div>
</div>
<div class="callout-body-container callout-body">
<p>最小二乘法的核心思想是找到一条直线，使得所有观测点到这条直线的垂直距离的平方和最小。这些垂直距离就是残差，代表了模型的预测误差。</p>
</div>
</div>
<p><strong>数学推导</strong>：</p>
<ol type="1">
<li><p><strong>残差平方和表达式</strong>：</p>
<ul>
<li>给定数据点 <span class="math inline">\((x_1, y_1), (x_2, y_2), \ldots, (x_n, y_n)\)</span></li>
<li>回归直线为 <span class="math inline">\(\hat{y} = \hat{\beta}_0 + \hat{\beta}_1 x\)</span></li>
<li>残差平方和 <span class="math inline">\(\text{RSS} = \sum_{i=1}^{n} (y_i - \hat{y}_i)^2 = \sum_{i=1}^{n} (y_i - (\hat{\beta}_0 + \hat{\beta}_1 x_i))^2\)</span></li>
</ul></li>
<li><p><strong>求最小值</strong>：</p>
<ul>
<li>对 <span class="math inline">\(\hat{\beta}_0\)</span> 和 <span class="math inline">\(\hat{\beta}_1\)</span> 分别求偏导数并令其等于零：</li>
</ul>
<p><span class="math display">\[\frac{\partial \text{RSS}}{\partial \hat{\beta}_0} = -2\sum_{i=1}^{n} (y_i - \hat{\beta}_0 - \hat{\beta}_1 x_i) = 0\]</span></p>
<p><span class="math display">\[\frac{\partial \text{RSS}}{\partial \hat{\beta}_1} = -2\sum_{i=1}^{n} x_i(y_i - \hat{\beta}_0 - \hat{\beta}_1 x_i) = 0\]</span></p></li>
<li><p><strong>解方程组</strong>：</p>
<ul>
<li><p>从第一个方程可得：<span class="math inline">\(\sum_{i=1}^{n} y_i - n\hat{\beta}_0 - \hat{\beta}_1 \sum_{i=1}^{n} x_i = 0\)</span></p></li>
<li><p>整理后得：<span class="math inline">\(\hat{\beta}_0 = \bar{y} - \hat{\beta}_1 \bar{x}\)</span>，其中 <span class="math inline">\(\bar{y}\)</span> 和 <span class="math inline">\(\bar{x}\)</span> 分别是 <span class="math inline">\(y\)</span> 和 <span class="math inline">\(x\)</span> 的平均值</p></li>
<li><p>将 <span class="math inline">\(\hat{\beta}_0\)</span> 代入第二个方程： <span class="math display">\[\sum_{i=1}^{n} x_i(y_i - (\bar{y} - \hat{\beta}_1 \bar{x}) - \hat{\beta}_1 x_i) = 0\]</span></p></li>
<li><p>化简后得： <span class="math display">\[\hat{\beta}_1 = \frac{\sum_{i=1}^{n}(x_i - \bar{x})(y_i - \bar{y})}{\sum_{i=1}^{n}(x_i - \bar{x})^2}\]</span></p></li>
</ul></li>
<li><p><strong>几何解释</strong>：</p>
<ul>
<li><span class="math inline">\(\hat{\beta}_1\)</span> 是 <span class="math inline">\(x\)</span> 和 <span class="math inline">\(y\)</span> 的协方差除以 <span class="math inline">\(x\)</span> 的方差</li>
<li>这使得回归线恰好穿过数据点的重心 <span class="math inline">\((\bar{x}, \bar{y})\)</span></li>
</ul></li>
<li><p><strong>矩阵形式</strong>：</p>
<ul>
<li>对于多元线性回归，最小二乘估计可以表示为：<span class="math inline">\(\hat{\beta} = (X^TX)^{-1}X^Ty\)</span></li>
<li>其中 <span class="math inline">\(X\)</span> 是自变量的设计矩阵，<span class="math inline">\(y\)</span> 是因变量向量</li>
</ul></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
最小二乘法求解的几何意义
</div>
</div>
<div class="callout-body-container callout-body">
<p>最小二乘法是在样本空间中寻找一个超平面，使得观测值与这个超平面之间的距离平方和最小。这相当于将因变量向量 <span class="math inline">\(y\)</span> 投影到自变量空间上，得到的投影向量就是预测值 <span class="math inline">\(\hat{y}\)</span>。</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 以rm(房间数)与medv(房价)为例应用最小二乘法</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算均值</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>x_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(Boston<span class="sc">$</span>rm)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>y_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(Boston<span class="sc">$</span>medv)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算β1（斜率）</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>numerator <span class="ot">&lt;-</span> <span class="fu">sum</span>((Boston<span class="sc">$</span>rm <span class="sc">-</span> x_mean) <span class="sc">*</span> (Boston<span class="sc">$</span>medv <span class="sc">-</span> y_mean))</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>denominator <span class="ot">&lt;-</span> <span class="fu">sum</span>((Boston<span class="sc">$</span>rm <span class="sc">-</span> x_mean)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>beta1 <span class="ot">&lt;-</span> numerator <span class="sc">/</span> denominator</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算β0（截距）</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>beta0 <span class="ot">&lt;-</span> y_mean <span class="sc">-</span> beta1 <span class="sc">*</span> x_mean</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 展示计算结果</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"手动计算的最小二乘估计值：</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>手动计算的最小二乘估计值：</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"斜率(β1) ="</span>, beta1, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>斜率(β1) = 9.102109 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"截距(β0) ="</span>, beta0, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>截距(β0) = -34.67062 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用lm函数验证结果</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(medv <span class="sc">~</span> rm, <span class="at">data =</span> Boston)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">lm函数计算的结果：</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
lm函数计算的结果：</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">coef</span>(model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)          rm 
 -34.670621    9.102109 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制回归线</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Boston, <span class="fu">aes</span>(<span class="at">x =</span> rm, <span class="at">y =</span> medv)) <span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> beta0, <span class="at">slope =</span> beta1, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"波士顿房价与平均房间数的关系"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"回归方程: 房价 = "</span>, <span class="fu">round</span>(beta0, <span class="dv">2</span>), <span class="st">" + "</span>, <span class="fu">round</span>(beta1, <span class="dv">2</span>), <span class="st">" × 房间数"</span>),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"平均房间数(rm)"</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"房价中位数(medv，千美元)"</span>) <span class="sc">+</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
回归系数的解释
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><span class="math inline">\(\hat{\beta}_0\)</span>：当自变量<span class="math inline">\(x\)</span>为0时，因变量<span class="math inline">\(y\)</span>的预测值（在实际情况中，自变量为0可能没有现实意义）</li>
<li><span class="math inline">\(\hat{\beta}_1\)</span>：自变量<span class="math inline">\(x\)</span>每增加一个单位，因变量<span class="math inline">\(y\)</span>的预测值平均增加<span class="math inline">\(\hat{\beta}_1\)</span>个单位（边际效应）</li>
</ul>
</div>
</div>
</section>
</section>
<section id="回归模型的评估指标" class="level2">
<h2 class="anchored" data-anchor-id="回归模型的评估指标">回归模型的评估指标</h2>
<p>在构建回归模型后，我们需要评估模型的性能，以了解模型的预测能力和拟合程度。以下是一些常用的评估指标：</p>
<ul>
<li><strong>决定系数 (R-squared, <span class="math inline">\(R^2\)</span>)</strong>：
<ul>
<li><strong>定义</strong>：衡量回归模型对因变量变异的解释程度。它表示模型可以解释因变量总变异的比例。</li>
<li><strong>取值范围</strong>：0 到 1 之间。</li>
<li><strong>解释</strong>：
<ul>
<li><span class="math inline">\(R^2\)</span> 越接近 1，表示模型拟合效果越好，模型能够解释因变量的大部分变异。</li>
<li><span class="math inline">\(R^2\)</span> 越接近 0，表示模型拟合效果越差，模型无法很好地解释因变量的变异。</li>
<li>例如，<span class="math inline">\(R^2 = 0.75\)</span> 表示模型可以解释 75% 的因变量变异。</li>
</ul></li>
<li><strong>优点</strong>：直观易懂，可以直接衡量模型对数据的拟合程度。</li>
<li><strong>缺点</strong>：<span class="math inline">\(R^2\)</span> 会随着自变量数量的增加而增加，即使增加的自变量对模型并没有实际的改进作用。因此，在比较包含不同数量自变量的模型时，单独使用 <span class="math inline">\(R^2\)</span> 可能会误导。</li>
</ul></li>
<li><strong>调整决定系数 (Adjusted <span class="math inline">\(R^2\)</span>)</strong>：
<ul>
<li><strong>定义</strong>：在 <span class="math inline">\(R^2\)</span> 的基础上，考虑了模型中自变量的数量。当模型中增加新的自变量时，如果该自变量对提高模型解释能力没有显著作用，调整 <span class="math inline">\(R^2\)</span> 会降低，从而避免了 <span class="math inline">\(R^2\)</span> 随着自变量数量增加而虚假增高的问题。</li>
<li><strong>计算方式</strong>：调整 <span class="math inline">\(R^2\)</span> 在计算时会惩罚模型中自变量的数量。</li>
<li><strong>解释</strong>：
<ul>
<li>调整 <span class="math inline">\(R^2\)</span> 更适用于比较包含不同数量自变量的模型。</li>
<li>调整 <span class="math inline">\(R^2\)</span> 越高，模型拟合效果越好，同时考虑了模型的简洁性。</li>
</ul></li>
<li><strong>适用场景</strong>：当需要在多个模型中选择最佳模型，且这些模型的自变量数量不同时，调整 <span class="math inline">\(R^2\)</span> 是一个更合适的指标。</li>
</ul></li>
<li><strong>均方误差 (Mean Squared Error, MSE)</strong>：
<ul>
<li><strong>定义</strong>：衡量预测值与真实值之间差异的平方的平均值。</li>
<li><strong>计算公式</strong>：<span class="math inline">\(\text{MSE} = \frac{1}{n} \sum_{i=1}^{n} (y_i - \hat{y}_i)^2\)</span>，其中 <span class="math inline">\(n\)</span> 是样本量，<span class="math inline">\(y_i\)</span> 是真实值，<span class="math inline">\(\hat{y}_i\)</span> 是预测值。</li>
<li><strong>单位</strong>：MSE 的单位是因变量单位的平方。</li>
<li><strong>解释</strong>：
<ul>
<li>MSE 越小，表示模型的预测值与真实值越接近，模型的预测精度越高。</li>
<li>MSE 对误差进行平方，使得较大的误差在 MSE 中占有更大的权重，因此 MSE 对异常值比较敏感。</li>
</ul></li>
</ul></li>
<li><strong>均方根误差 (Root Mean Squared Error, RMSE)</strong>：
<ul>
<li><strong>定义</strong>：均方误差 (MSE) 的平方根。</li>
<li><strong>计算公式</strong>：<span class="math inline">\(\text{RMSE} = \sqrt{\text{MSE}} = \sqrt{\frac{1}{n} \sum_{i=1}^{n} (y_i - \hat{y}_i)^2}\)</span></li>
<li><strong>单位</strong>：RMSE 的单位与因变量的单位相同，因此在解释上更直观。</li>
<li><strong>解释</strong>：
<ul>
<li>RMSE 越小，表示模型的预测值与真实值越接近，模型的预测精度越高。</li>
<li>RMSE 与 MSE 一样，对异常值比较敏感。</li>
<li>由于 RMSE 的单位与因变量相同，因此更容易解释预测误差的大小。例如，RMSE = 10 表示平均预测误差约为 10 个单位。</li>
</ul></li>
</ul></li>
<li><strong>平均绝对误差 (Mean Absolute Error, MAE)</strong>：
<ul>
<li><strong>定义</strong>：衡量预测值与真实值之间差异的绝对值的平均值。</li>
<li><strong>计算公式</strong>：<span class="math inline">\(\text{MAE} = \frac{1}{n} \sum_{i=1}^{n} |y_i - \hat{y}_i|\)</span></li>
<li><strong>单位</strong>：MAE 的单位与因变量的单位相同。</li>
<li><strong>解释</strong>：
<ul>
<li>MAE 越小，表示模型的预测值与真实值越接近，模型的预测精度越高。</li>
<li>MAE 对所有误差都给予相同的权重，因此对异常值不如 MSE 和 RMSE 敏感，更加稳健。</li>
<li>MAE 直接反映了预测值偏离真实值的平均程度，例如，MAE = 5 表示平均预测误差约为 5 个单位。</li>
</ul></li>
<li><strong>适用场景</strong>：当数据中存在异常值，并且希望模型对异常值不那么敏感时，MAE 是一个比 MSE 和 RMSE 更好的选择。</li>
</ul></li>
</ul>
<p>总而言之，选择合适的评估指标取决于具体的应用场景和对模型误差的关注重点。在实际应用中，通常会综合考虑多个评估指标来全面评价回归模型的性能。</p>
</section>
<section id="回归系数统计性质" class="level2">
<h2 class="anchored" data-anchor-id="回归系数统计性质">回归系数统计性质</h2>
<section id="最小二乘估计的统计性质-高斯-马尔可夫定理" class="level3">
<h3 class="anchored" data-anchor-id="最小二乘估计的统计性质-高斯-马尔可夫定理">最小二乘估计的统计性质 (高斯-马尔可夫定理)</h3>
<p>在经典线性回归模型的假设条件下（线性性、随机抽样、严格外生性、完全共线性、球型扰动项），最小二乘估计 (OLS) 具有以下优良的统计性质：</p>
<ul>
<li><strong>无偏性 (Unbiasedness)</strong>：OLS估计的系数 <span class="math inline">\(\hat{\beta}\)</span> 的期望值等于真实系数 <span class="math inline">\(\beta\)</span>，即 <span class="math inline">\(E(\hat{\beta}) = \beta\)</span>。这意味着在多次抽样中，OLS估计的平均值会接近真实值。</li>
<li><strong>有效性 (Efficiency)</strong>：在所有线性无偏估计量中，OLS估计量具有最小的方差。这意味着OLS估计是最精确的线性无偏估计量，也称为最佳线性无偏估计量 (BLUE, Best Linear Unbiased Estimator)。</li>
<li><strong>一致性 (Consistency)</strong>：随着样本容量 <span class="math inline">\(n\)</span> 趋于无穷大，OLS估计量 <span class="math inline">\(\hat{\beta}\)</span> 依概率收敛于真实系数 <span class="math inline">\(\beta\)</span>，即 <span class="math inline">\(\text{plim}_{n\to\infty} \hat{\beta} = \beta\)</span>。这意味着当样本量足够大时，OLS估计会非常接近真实值。</li>
<li><strong>正态性 (Normality)</strong>：在扰动项 <span class="math inline">\(\epsilon\)</span> 服从正态分布的假设下，OLS估计量 <span class="math inline">\(\hat{\beta}\)</span> 也服从正态分布。这一性质使得我们可以进行基于正态分布的假设检验和置信区间估计。</li>
</ul>
</section>
<section id="假设检验" class="level3">
<h3 class="anchored" data-anchor-id="假设检验">假设检验</h3>
<p>在回归分析中，假设检验用于评估模型中自变量对因变量的影响是否显著，以及整个模型是否具有统计学意义。</p>
<p><strong>1. 对单个回归系数的t检验</strong></p>
<ul>
<li><strong>目的</strong>：检验每个自变量的系数 <span class="math inline">\(\beta_i\)</span> 是否显著不为零，即该自变量是否对因变量有显著影响。</li>
<li><strong>零假设 (<span class="math inline">\(H_0\)</span>)</strong>：<span class="math inline">\(\beta_i = 0\)</span> (自变量 <span class="math inline">\(x_i\)</span> 对因变量 <span class="math inline">\(y\)</span> 没有线性影响)</li>
<li><strong>备择假设 (<span class="math inline">\(H_1\)</span>)</strong>：<span class="math inline">\(\beta_i \neq 0\)</span> (自变量 <span class="math inline">\(x_i\)</span> 对因变量 <span class="math inline">\(y\)</span> 有线性影响)</li>
<li><strong>检验统计量</strong>：t统计量，通过系数估计值 <span class="math inline">\(\hat{\beta}_i\)</span> 除以其标准误差 <span class="math inline">\(SE(\hat{\beta}_i)\)</span> 计算得到。</li>
<li><strong>决策</strong>：将计算得到的t统计量的p值与显著性水平 <span class="math inline">\(\alpha\)</span> (通常为0.05) 进行比较。若p值小于 <span class="math inline">\(\alpha\)</span>，则拒绝零假设，认为自变量 <span class="math inline">\(x_i\)</span> 对因变量 <span class="math inline">\(y\)</span> 的影响在统计上是显著的。</li>
</ul>
<p><strong>2. 对整体模型显著性的F检验</strong></p>
<ul>
<li><strong>目的</strong>：检验模型中所有自变量是否作为一个整体对因变量有显著影响，即模型是否整体有效。</li>
<li><strong>零假设 (<span class="math inline">\(H_0\)</span>)</strong>：<span class="math inline">\(\beta_1 = \beta_2 = ... = \beta_p = 0\)</span> (所有自变量都对因变量没有线性影响，模型整体无效)</li>
<li><strong>备择假设 (<span class="math inline">\(H_1\)</span>)</strong>：<span class="math inline">\(\beta_j \neq 0\)</span> 至少存在一个 <span class="math inline">\(j\)</span> (至少有一个自变量对因变量有线性影响，模型整体有效)</li>
<li><strong>检验统计量</strong>：F统计量，通过分析模型的方差分解得到，衡量模型解释的变异与未解释的变异之比。</li>
<li><strong>决策</strong>：将计算得到的F统计量的p值与显著性水平 <span class="math inline">\(\alpha\)</span> 进行比较。若p值小于 <span class="math inline">\(\alpha\)</span>，则拒绝零假设，认为模型作为一个整体对因变量的影响在统计上是显著的。</li>
</ul>
<p>这些性质保证了在满足经典线性回归模型假设的前提下，使用最小二乘法得到的回归系数估计是可靠和有效的。然而，在实际应用中，我们需要检验这些假设是否成立，并根据具体情况选择合适的回归方法。</p>
</section>
<section id="回归假设不满足时的问题及解决方法" class="level3">
<h3 class="anchored" data-anchor-id="回归假设不满足时的问题及解决方法">回归假设不满足时的问题及解决方法</h3>
<div class="callout callout-style-simple callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
线性性假设不满足
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>问题</strong>：</p>
<ul>
<li>若实际关系不是线性的，模型会系统性地预测不准</li>
<li>残差图会呈现明显的非随机模式（如U形或倒U形）</li>
</ul>
<p><strong>解决方法</strong>：</p>
<ul>
<li>对变量进行非线性变换（如对数、平方根、平方等）</li>
<li>添加多项式项（如<span class="math inline">\(x^2\)</span>、<span class="math inline">\(x^3\)</span>等）</li>
<li>使用样条函数或局部回归等非参数方法</li>
<li>对具体业务关系，考虑使用非线性回归模型</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 非线性关系示例：lstat与房价的关系更像指数关系</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 比较线性模型与对数变换模型</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>model_linear <span class="ot">&lt;-</span> <span class="fu">lm</span>(medv <span class="sc">~</span> lstat, <span class="at">data =</span> Boston)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>model_log <span class="ot">&lt;-</span> <span class="fu">lm</span>(medv <span class="sc">~</span> <span class="fu">log</span>(lstat), <span class="at">data =</span> Boston)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建预测值</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>Boston<span class="sc">$</span>pred_linear <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_linear)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>Boston<span class="sc">$</span>pred_log <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_log)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 可视化比较</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Boston, <span class="fu">aes</span>(<span class="at">x =</span> lstat, <span class="at">y =</span> medv)) <span class="sc">+</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> pred_linear), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"线性模型"</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"低收入人口比例(%)"</span>,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"房价(千美元)"</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(Boston, <span class="fu">aes</span>(<span class="at">x =</span> lstat, <span class="at">y =</span> medv)) <span class="sc">+</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> pred_log), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"对数变换模型"</span>,</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"低收入人口比例(%)"</span>,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"房价(千美元)"</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 比较模型拟合度</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"线性模型 R² ="</span>, <span class="fu">summary</span>(model_linear)<span class="sc">$</span>r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>线性模型 R² = 0.5441463 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"对数变换模型 R² ="</span>, <span class="fu">summary</span>(model_log)<span class="sc">$</span>r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>对数变换模型 R² = 0.6649462 </code></pre>
</div>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
同方差性假设不满足（异方差性）
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>问题</strong>：</p>
<ul>
<li>误差的方差不恒定，在某些预测区间的预测更不准确</li>
<li>标准误差估计有偏，导致置信区间和假设检验不可靠</li>
<li>最小二乘估计虽然无偏但不再是最有效的</li>
</ul>
<p><strong>解决方法</strong>：</p>
<ul>
<li>对因变量进行变换（如对数变换）</li>
<li>使用加权最小二乘法(WLS)</li>
<li>使用稳健标准误差(Robust Standard Errors)</li>
<li>使用广义线性模型(GLM)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 检测异方差性</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_linear, <span class="at">which =</span> <span class="dv">1</span>)  <span class="co"># 残差图</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 进行BP检验</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 原假设H0：误差项具有同方差性</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 备择假设H1：误差项不具有同方差性（存在异方差性）</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="fu">bptest</span>(model_linear)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    studentized Breusch-Pagan test

data:  model_linear
BP = 15.497, df = 1, p-value = 8.262e-05</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用稳健标准误差</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 当模型存在异方差性时，普通最小二乘法（OLS）系数的标准误差估计会失效，导致推断不可靠。</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 稳健标准误差提供了一种有效的方法来估计系数的标准误差，即使存在异方差性。</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 在R中，`sandwich` 包的 `vcovHC` 函数可以计算稳健的协方差矩阵，然后与 `lmtest` 包的 `coeftest` 函数结合使用，进行基于稳健标准误差的系数检验。</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># HC1 是一种常用的稳健标准误差类型。</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(model_linear, <span class="at">vcov =</span> <span class="fu">vcovHC</span>(model_linear, <span class="at">type =</span> <span class="st">"HC1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
t test of coefficients:

             Estimate Std. Error t value  Pr(&gt;|t|)    
(Intercept) 34.553841   0.754199  45.815 &lt; 2.2e-16 ***
lstat       -0.950049   0.049605 -19.152 &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 加权最小二乘法示例：当误差项方差不齐时，WLS通过赋予不同观测点不同的权重来优化模型，通常权重与方差成反比。</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算残差的绝对值</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>abs_resid <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">residuals</span>(model_linear))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 基于预测值拟合残差模型</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>weight_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(abs_resid <span class="sc">~</span> <span class="fu">fitted</span>(model_linear))</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算权重</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>weights <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="fu">fitted</span>(weight_model)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 拟合WLS模型</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>wls_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(medv <span class="sc">~</span> lstat, <span class="at">data =</span> Boston, <span class="at">weights =</span> weights)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 比较结果</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_linear)<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              Estimate Std. Error   t value      Pr(&gt;|t|)
(Intercept) 34.5538409 0.56262735  61.41515 3.743081e-236
lstat       -0.9500494 0.03873342 -24.52790  5.081103e-88</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(wls_model)<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              Estimate Std. Error   t value      Pr(&gt;|t|)
(Intercept) 31.5869876 0.54902271  57.53312 1.213416e-223
lstat       -0.7295561 0.02944518 -24.77676  3.134190e-89</code></pre>
</div>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
独立性假设不满足（自相关）
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>问题</strong>：</p>
<ul>
<li>误差项之间存在相关性，常见于时间序列数据</li>
<li>标准误差估计有偏，影响推断的有效性</li>
<li>预测区间不准确</li>
</ul>
<p><strong>解决方法</strong>：</p>
<ul>
<li>增加漏掉的解释变量</li>
<li>纳入滞后项或时间趋势</li>
<li>使用广义最小二乘法(GLS)</li>
<li>对时间序列数据使用ARIMA等专门模型</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 创建一个人为的自相关序列</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>n</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>trend <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> time</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>error <span class="ot">&lt;-</span> <span class="fu">arima.sim</span>(<span class="fu">list</span>(<span class="at">ar =</span> <span class="fl">0.8</span>), n)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> trend <span class="sc">+</span> error</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>data_ts <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time, <span class="at">y =</span> y)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 拟合简单线性模型</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>ts_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> time, <span class="at">data =</span> data_ts)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ts_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ time, data = data_ts)

Residuals:
    Min      1Q  Median      3Q     Max 
-3.1652 -0.9830 -0.1245  0.7012  4.2521 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 0.835800   0.276027   3.028  0.00315 ** 
time        0.485589   0.004745 102.330  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.37 on 98 degrees of freedom
Multiple R-squared:  0.9907,    Adjusted R-squared:  0.9906 
F-statistic: 1.047e+04 on 1 and 98 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 检测自相关性</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Durbin-Watson检验</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 原假设H0：误差项不存在自相关性</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 备择假设H1：误差项存在自相关性</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dwtest</span>(ts_model)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Durbin-Watson test

data:  ts_model
DW = 0.45546, p-value = 1.324e-15
alternative hypothesis: true autocorrelation is greater than 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 可视化残差</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">residuals</span>(ts_model), <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">main =</span> <span class="st">"残差时间序列"</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(<span class="fu">residuals</span>(ts_model), <span class="at">main =</span> <span class="st">"残差自相关函数"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用广义最小二乘法纠正自相关</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>gls_model <span class="ot">&lt;-</span> <span class="fu">gls</span>(y <span class="sc">~</span> time, <span class="at">data =</span> data_ts, <span class="at">correlation =</span> <span class="fu">corAR1</span>())</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gls_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized least squares fit by REML
  Model: y ~ time 
  Data: data_ts 
       AIC      BIC    logLik
  271.5459 281.8857 -131.7729

Correlation Structure: AR(1)
 Formula: ~1 
 Parameter estimate(s):
      Phi 
0.8240619 

Coefficients:
                Value Std.Error  t-value p-value
(Intercept) 0.2796805 0.9025675  0.30987  0.7573
time        0.4943710 0.0151567 32.61735  0.0000

 Correlation: 
     (Intr)
time -0.848

Standardized residuals:
        Min          Q1         Med          Q3         Max 
-1.74572651 -0.50538885  0.04785484  0.59576388  2.69940933 

Residual standard error: 1.553479 
Degrees of freedom: 100 total; 98 residual</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 重置图形参数</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
正态性假设不满足
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>问题</strong>： - 对小样本影响较大，使用t检验和F检验可能不可靠 - 异常值对回归分析的影响过大</p>
<p><strong>解决方法</strong>： - 对异常值进行识别与处理 - 尝试对因变量进行变换（如Box-Cox变换） - 使用非参数方法或稳健回归 - 对大样本，由于中心极限定理，影响相对较小</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 检验残差正态性</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(<span class="fu">residuals</span>(model_linear))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(model_linear)
W = 0.87857, p-value &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 残差QQ图</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">residuals</span>(model_linear))</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(<span class="fu">residuals</span>(model_linear))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Box-Cox变换</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>bc <span class="ot">&lt;-</span> <span class="fu">boxcox</span>(model_linear)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> bc<span class="sc">$</span>x[<span class="fu">which.max</span>(bc<span class="sc">$</span>y)]</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"最优Box-Cox变换参数λ ="</span>, lambda, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>最优Box-Cox变换参数λ = 0.02020202 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 应用Box-Cox变换</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">abs</span>(lambda) <span class="sc">&lt;</span> <span class="fl">0.001</span>) {</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  Boston<span class="sc">$</span>trans_medv <span class="ot">&lt;-</span> <span class="fu">log</span>(Boston<span class="sc">$</span>medv)  <span class="co"># λ接近0时使用对数变换</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  Boston<span class="sc">$</span>trans_medv <span class="ot">&lt;-</span> (Boston<span class="sc">$</span>medv<span class="sc">^</span>lambda <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> lambda</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 拟合变换后的模型</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>trans_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(trans_medv <span class="sc">~</span> lstat, <span class="at">data =</span> Boston)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(<span class="fu">residuals</span>(trans_model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(trans_model)
W = 0.9711, p-value = 1.938e-08</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 稳健回归</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>robust_model <span class="ot">&lt;-</span> <span class="fu">rlm</span>(medv <span class="sc">~</span> lstat, <span class="at">data =</span> Boston)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(robust_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call: rlm(formula = medv ~ lstat, data = Boston)
Residuals:
     Min       1Q   Median       3Q      Max 
-13.7025  -2.9250  -0.4713   3.0462  25.8080 

Coefficients:
            Value    Std. Error t value 
(Intercept)  32.3389   0.4273    75.6866
lstat        -0.8549   0.0294   -29.0623

Residual standard error: 4.358 on 504 degrees of freedom</code></pre>
</div>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
多重共线性（多元回归中的问题）
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>问题</strong>： - 自变量之间高度相关，导致系数估计不稳定 - 标准误差增大，显著性检验不可靠 - 模型解释能力下降</p>
<p><strong>解决方法</strong>： - 删除高度相关的变量 - 使用变量选择方法（如逐步回归） - 主成分回归或偏最小二乘回归 - 岭回归或Lasso等正则化方法</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 多元回归示例</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>multi_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(medv <span class="sc">~</span> rm <span class="sc">+</span> lstat <span class="sc">+</span> crim <span class="sc">+</span> nox, <span class="at">data =</span> Boston)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 检测多重共线性</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="fu">vif</span>(multi_model)  <span class="co"># VIF &gt; 10表示严重的多重共线性</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      rm    lstat     crim      nox 
1.626591 2.440211 1.327046 1.618307 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 相关矩阵</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>cor_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(Boston[, <span class="fu">c</span>(<span class="st">"rm"</span>, <span class="st">"lstat"</span>, <span class="st">"crim"</span>, <span class="st">"nox"</span>)])</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cor_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              rm      lstat       crim        nox
rm     1.0000000 -0.6138083 -0.2192467 -0.3021882
lstat -0.6138083  1.0000000  0.4556215  0.5908789
crim  -0.2192467  0.4556215  1.0000000  0.4209717
nox   -0.3021882  0.5908789  0.4209717  1.0000000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 岭回归示例</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>ridge_model <span class="ot">&lt;-</span> <span class="fu">lm.ridge</span>(medv <span class="sc">~</span> rm <span class="sc">+</span> lstat <span class="sc">+</span> crim <span class="sc">+</span> nox, <span class="at">data =</span> Boston, <span class="at">lambda =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.01</span>))</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ridge_model)  <span class="co"># 绘制岭迹图</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 选择最优lambda值</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>optimal_lambda <span class="ot">&lt;-</span> ridge_model<span class="sc">$</span>lambda[<span class="fu">which.min</span>(ridge_model<span class="sc">$</span>GCV)]</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"最优岭参数λ ="</span>, optimal_lambda, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>最优岭参数λ = 1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>ridge_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(ridge_model)[<span class="fu">which</span>(ridge_model<span class="sc">$</span>lambda <span class="sc">==</span> optimal_lambda), ]</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ridge_coef)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   rm      lstat       crim        nox 
-2.4799828  5.2144817 -0.5758662 -0.1027447 -0.1813245 </code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="r语言实现简单线性回归" class="level3">
<h3 class="anchored" data-anchor-id="r语言实现简单线性回归">R语言实现简单线性回归</h3>
<p><strong>基本函数</strong>：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 以rm(房间数)预测房价为例</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 建立简单线性回归模型</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>lm_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(medv <span class="sc">~</span> rm, <span class="at">data =</span> Boston)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 broom 包获取模型摘要信息</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取整洁的模型系数</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(lm_model, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 7
  term        estimate std.error statistic  p.value conf.low conf.high
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)   -34.7      2.65      -13.1 6.95e-34   -39.9     -29.5 
2 rm              9.10     0.419      21.7 2.49e-74     8.28      9.93</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取整洁的模型摘要统计量</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(lm_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 12
  r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC   BIC
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     0.484         0.483  6.62      472. 2.49e-74     1 -1673. 3352. 3365.
# ℹ 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 模型预测</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>new_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">rm =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>))</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 augment 获取带预测值和残差的数据框</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>augmented_data <span class="ot">&lt;-</span> <span class="fu">augment</span>(lm_model, <span class="at">newdata =</span> new_data, <span class="at">interval =</span> <span class="st">"confidence"</span>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>augmented_prediction <span class="ot">&lt;-</span> <span class="fu">augment</span>(lm_model, <span class="at">newdata =</span> new_data, <span class="at">interval =</span> <span class="st">"prediction"</span>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>augmented_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
     rm .fitted .lower .upper
  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1     5    10.8   9.63   12.0
2     6    19.9  19.3    20.6
3     7    29.0  28.2    29.9
4     8    38.1  36.6    39.7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>augmented_prediction</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
     rm .fitted .lower .upper
  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1     5    10.8  -2.21   23.9
2     6    19.9   6.93   33.0
3     7    29.0  16.0    42.1
4     8    38.1  25.1    51.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 回归诊断图</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 ggfortify 包可以绘制更美观的回归诊断图，它是 ggplot2 的扩展包</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggfortify)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(lm_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
<p><strong>结果解读</strong>：</p>
<ul>
<li><strong>系数估计值</strong>：截距(<span class="math inline">\(\hat{\beta}_0\)</span>)和斜率(<span class="math inline">\(\hat{\beta}_1\)</span>)的估计值</li>
<li><strong>标准误差</strong>：系数估计值的标准误差，表示估计的精确度</li>
<li><strong>t值</strong>：系数估计值与标准误差的比值，用于检验系数是否显著不为0</li>
<li><strong>p值</strong>：系数是否显著不为0的显著性水平</li>
<li><strong>R²值</strong>：模型解释的方差比例，衡量拟合优度</li>
<li><strong>F统计量</strong>：整个模型的显著性检验</li>
</ul>
</section>
</section>
<section id="第十二次课多元线性回归模型" class="level2">
<h2 class="anchored" data-anchor-id="第十二次课多元线性回归模型">第十二次课：多元线性回归模型</h2>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
本节课重点
</div>
</div>
<div class="callout-body-container callout-body">
<p>在上节课我们学习了线性回归的基本原理和简单线性回归模型。本节课我们将扩展到多元线性回归模型，并特别关注多变量回归分析中的一个核心问题：<strong>变量选择</strong>。</p>
<p>在实际应用中，我们通常有很多潜在的自变量可以纳入模型。如何从众多变量中选择最优的变量组合，是构建高效回归模型的关键步骤。本节课将介绍各种变量选择的方法、标准和实用技巧，帮助我们构建既有预测能力又有解释力的回归模型。</p>
</div>
</div>
<section id="多元线性回归模型" class="level3">
<h3 class="anchored" data-anchor-id="多元线性回归模型">多元线性回归模型</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
多元线性回归的意义
</div>
</div>
<div class="callout-body-container callout-body">
<p>在商业环境中，一个因变量往往受多个因素影响。例如，销售额不仅受电视广告的影响，还可能受广播、报纸、社交媒体等多种营销渠道的影响。多元线性回归能够同时考虑多个自变量的影响，更全面地分析因素间的关系。</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
模型形式
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math inline">\(y = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \dots + \beta_p x_p + \epsilon\)</span></p>
<ul>
<li><span class="math inline">\(y\)</span>：因变量</li>
<li><span class="math inline">\(x_1, x_2, \dots, x_p\)</span>：<span class="math inline">\(p\)</span>个自变量</li>
<li><span class="math inline">\(\beta_0\)</span>：截距</li>
<li><span class="math inline">\(\beta_1, \beta_2, \dots, \beta_p\)</span>：偏回归系数，控制其他自变量不变时，每个自变量对因变量的边际影响</li>
<li><span class="math inline">\(\epsilon\)</span>：随机误差项</li>
</ul>
</div>
</div>
</section>
</section>
<section id="偏回归系数的解释" class="level2 callout-hint">
<h2 class="anchored" data-anchor-id="偏回归系数的解释">偏回归系数的解释</h2>
<ul>
<li><span class="math inline">\(\beta_1\)</span>表示在其他自变量<span class="math inline">\(x_2, \dots, x_p\)</span>保持不变的情况下，自变量<span class="math inline">\(x_1\)</span>每增加一个单位，因变量<span class="math inline">\(y\)</span>的平均变化量</li>
</ul>
<p>这个解释非常重要，因为它体现了”控制变量”的思想，即我们能够分离出单个自变量的”净效应”。这在商业分析中尤为有用，例如，我们可以分析在广播广告投入不变的情况下，增加电视广告对销售的边际贡献。</p>
</section>
<section id="变量选择问题" class="level3">
<h3 class="anchored" data-anchor-id="变量选择问题">变量选择问题</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
为什么需要变量选择
</div>
</div>
<div class="callout-body-container callout-body">
<p>在多元回归分析中，并非所有可能的自变量都对模型有显著贡献。变量选择旨在从众多潜在自变量中筛选出最重要的变量，构建既简洁又高效的模型。变量选择的主要目的包括：</p>
<ol type="1">
<li><strong>提高模型解释力</strong>：删除无关变量，使模型更聚焦于真正有影响的因素</li>
<li><strong>增强预测能力</strong>：简化模型可以减少过拟合风险，提高在新数据上的预测准确性</li>
<li><strong>降低计算复杂度</strong>：减少模型中的变量数量可以简化计算</li>
<li><strong>避免多重共线性</strong>：排除高度相关的变量，提高参数估计的稳定性</li>
<li><strong>增强模型可解释性</strong>：更少的变量意味着模型更易于理解和解释</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
变量选择的挑战
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>组合爆炸</strong>：对于p个自变量，存在<span class="math inline">\(2^p\)</span>种可能的模型组合</li>
<li><strong>模型不确定性</strong>：不同的选择标准可能导致不同的”最优”模型</li>
<li><strong>数据驱动vs理论驱动</strong>：纯粹数据驱动的变量选择可能忽略重要的理论考量</li>
<li><strong>过度拟合风险</strong>：过度使用统计标准进行变量选择可能导致过拟合</li>
</ul>
</div>
</div>
</section>
<section id="变量选择的方法" class="level3">
<h3 class="anchored" data-anchor-id="变量选择的方法">变量选择的方法</h3>
<section id="传统变量选择方法" class="level4">
<h4 class="anchored" data-anchor-id="传统变量选择方法">传统变量选择方法</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用波士顿房价数据集进行变量选择示例</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Boston)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 构建包含所有变量的完整模型</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>full_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(medv <span class="sc">~</span> ., <span class="at">data =</span> Boston)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(full_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = medv ~ ., data = Boston)

Residuals:
    Min      1Q  Median      3Q     Max 
-15.595  -2.730  -0.518   1.777  26.199 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  3.646e+01  5.103e+00   7.144 3.28e-12 ***
crim        -1.080e-01  3.286e-02  -3.287 0.001087 ** 
zn           4.642e-02  1.373e-02   3.382 0.000778 ***
indus        2.056e-02  6.150e-02   0.334 0.738288    
chas         2.687e+00  8.616e-01   3.118 0.001925 ** 
nox         -1.777e+01  3.820e+00  -4.651 4.25e-06 ***
rm           3.810e+00  4.179e-01   9.116  &lt; 2e-16 ***
age          6.922e-04  1.321e-02   0.052 0.958229    
dis         -1.476e+00  1.995e-01  -7.398 6.01e-13 ***
rad          3.060e-01  6.635e-02   4.613 5.07e-06 ***
tax         -1.233e-02  3.760e-03  -3.280 0.001112 ** 
ptratio     -9.527e-01  1.308e-01  -7.283 1.31e-12 ***
black        9.312e-03  2.686e-03   3.467 0.000573 ***
lstat       -5.248e-01  5.072e-02 -10.347  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.745 on 492 degrees of freedom
Multiple R-squared:  0.7406,    Adjusted R-squared:  0.7338 
F-statistic: 108.1 on 13 and 492 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
1. 向前逐步回归 (Forward Stepwise)
</div>
</div>
<div class="callout-body-container callout-body">
<p>从一个没有自变量的模型开始（只有截距），然后每次添加一个最能提高模型拟合度的变量，直到没有变量能显著改善模型或达到预定的停止标准。</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 向前逐步回归</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>null_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(medv <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> Boston)  <span class="co"># 仅含截距的模型</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>forward_model <span class="ot">&lt;-</span> <span class="fu">step</span>(null_model, <span class="at">scope =</span> <span class="fu">list</span>(<span class="at">lower =</span> null_model, <span class="at">upper =</span> full_model), </span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">direction =</span> <span class="st">"forward"</span>, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看最终模型</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(forward_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = medv ~ lstat + rm + ptratio + dis + nox + chas + 
    black + zn + crim + rad + tax, data = Boston)

Residuals:
     Min       1Q   Median       3Q      Max 
-15.5984  -2.7386  -0.5046   1.7273  26.2373 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  36.341145   5.067492   7.171 2.73e-12 ***
lstat        -0.522553   0.047424 -11.019  &lt; 2e-16 ***
rm            3.801579   0.406316   9.356  &lt; 2e-16 ***
ptratio      -0.946525   0.129066  -7.334 9.24e-13 ***
dis          -1.492711   0.185731  -8.037 6.84e-15 ***
nox         -17.376023   3.535243  -4.915 1.21e-06 ***
chas          2.718716   0.854240   3.183 0.001551 ** 
black         0.009291   0.002674   3.475 0.000557 ***
zn            0.045845   0.013523   3.390 0.000754 ***
crim         -0.108413   0.032779  -3.307 0.001010 ** 
rad           0.299608   0.063402   4.726 3.00e-06 ***
tax          -0.011778   0.003372  -3.493 0.000521 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.736 on 494 degrees of freedom
Multiple R-squared:  0.7406,    Adjusted R-squared:  0.7348 
F-statistic: 128.2 on 11 and 494 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看选择过程</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">step</span>(null_model, <span class="at">scope =</span> <span class="fu">list</span>(<span class="at">lower =</span> null_model, <span class="at">upper =</span> full_model), </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="st">"forward"</span>, <span class="at">trace =</span> <span class="cn">TRUE</span>, <span class="at">steps =</span> <span class="dv">2</span>)  <span class="co"># 仅显示前两步以节省空间</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Start:  AIC=2246.51
medv ~ 1

          Df Sum of Sq   RSS    AIC
+ lstat    1   23243.9 19472 1851.0
+ rm       1   20654.4 22062 1914.2
+ ptratio  1   11014.3 31702 2097.6
+ indus    1    9995.2 32721 2113.6
+ tax      1    9377.3 33339 2123.1
+ nox      1    7800.1 34916 2146.5
+ crim     1    6440.8 36276 2165.8
+ rad      1    6221.1 36495 2168.9
+ age      1    6069.8 36647 2171.0
+ zn       1    5549.7 37167 2178.1
+ black    1    4749.9 37966 2188.9
+ dis      1    2668.2 40048 2215.9
+ chas     1    1312.1 41404 2232.7
&lt;none&gt;                 42716 2246.5

Step:  AIC=1851.01
medv ~ lstat

          Df Sum of Sq   RSS    AIC
+ rm       1    4033.1 15439 1735.6
+ ptratio  1    2670.1 16802 1778.4
+ chas     1     786.3 18686 1832.2
+ dis      1     772.4 18700 1832.5
+ age      1     304.3 19168 1845.0
+ tax      1     274.4 19198 1845.8
+ black    1     198.3 19274 1847.8
+ zn       1     160.3 19312 1848.8
+ crim     1     146.9 19325 1849.2
+ indus    1      98.7 19374 1850.4
&lt;none&gt;                 19472 1851.0
+ rad      1      25.1 19447 1852.4
+ nox      1       4.8 19468 1852.9

Step:  AIC=1735.58
medv ~ lstat + rm</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = medv ~ lstat + rm, data = Boston)

Coefficients:
(Intercept)        lstat           rm  
    -1.3583      -0.6424       5.0948  </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
2. 向后逐步回归 (Backward Stepwise)
</div>
</div>
<div class="callout-body-container callout-body">
<p>从一个包含所有自变量的模型开始，然后每次删除一个对模型贡献最小的变量，直到所有剩余变量都对模型有显著贡献。</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 向后逐步回归</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>backward_model <span class="ot">&lt;-</span> <span class="fu">step</span>(full_model, <span class="at">direction =</span> <span class="st">"backward"</span>, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看最终模型</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(backward_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = medv ~ crim + zn + chas + nox + rm + dis + rad + 
    tax + ptratio + black + lstat, data = Boston)

Residuals:
     Min       1Q   Median       3Q      Max 
-15.5984  -2.7386  -0.5046   1.7273  26.2373 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  36.341145   5.067492   7.171 2.73e-12 ***
crim         -0.108413   0.032779  -3.307 0.001010 ** 
zn            0.045845   0.013523   3.390 0.000754 ***
chas          2.718716   0.854240   3.183 0.001551 ** 
nox         -17.376023   3.535243  -4.915 1.21e-06 ***
rm            3.801579   0.406316   9.356  &lt; 2e-16 ***
dis          -1.492711   0.185731  -8.037 6.84e-15 ***
rad           0.299608   0.063402   4.726 3.00e-06 ***
tax          -0.011778   0.003372  -3.493 0.000521 ***
ptratio      -0.946525   0.129066  -7.334 9.24e-13 ***
black         0.009291   0.002674   3.475 0.000557 ***
lstat        -0.522553   0.047424 -11.019  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.736 on 494 degrees of freedom
Multiple R-squared:  0.7406,    Adjusted R-squared:  0.7348 
F-statistic: 128.2 on 11 and 494 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 比较向前和向后方法的结果</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"向前逐步回归选择的变量："</span>, </span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="fu">names</span>(<span class="fu">coef</span>(forward_model))[<span class="sc">-</span><span class="dv">1</span>], <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>向前逐步回归选择的变量： lstat, rm, ptratio, dis, nox, chas, black, zn, crim, rad, tax </code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"向后逐步回归选择的变量："</span>, </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(<span class="fu">names</span>(<span class="fu">coef</span>(backward_model))[<span class="sc">-</span><span class="dv">1</span>], <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>向后逐步回归选择的变量： crim, zn, chas, nox, rm, dis, rad, tax, ptratio, black, lstat </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
3. 双向逐步回归 (Stepwise)
</div>
</div>
<div class="callout-body-container callout-body">
<p>结合向前和向后方法，每一步可以添加或删除变量。在每次添加变量后，会重新评估所有已经在模型中的变量，可能删除不再显著的变量。</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 双向逐步回归</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>stepwise_model <span class="ot">&lt;-</span> <span class="fu">step</span>(null_model, <span class="at">scope =</span> <span class="fu">list</span>(<span class="at">lower =</span> null_model, <span class="at">upper =</span> full_model), </span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">direction =</span> <span class="st">"both"</span>, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看最终模型</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(stepwise_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = medv ~ lstat + rm + ptratio + dis + nox + chas + 
    black + zn + crim + rad + tax, data = Boston)

Residuals:
     Min       1Q   Median       3Q      Max 
-15.5984  -2.7386  -0.5046   1.7273  26.2373 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  36.341145   5.067492   7.171 2.73e-12 ***
lstat        -0.522553   0.047424 -11.019  &lt; 2e-16 ***
rm            3.801579   0.406316   9.356  &lt; 2e-16 ***
ptratio      -0.946525   0.129066  -7.334 9.24e-13 ***
dis          -1.492711   0.185731  -8.037 6.84e-15 ***
nox         -17.376023   3.535243  -4.915 1.21e-06 ***
chas          2.718716   0.854240   3.183 0.001551 ** 
black         0.009291   0.002674   3.475 0.000557 ***
zn            0.045845   0.013523   3.390 0.000754 ***
crim         -0.108413   0.032779  -3.307 0.001010 ** 
rad           0.299608   0.063402   4.726 3.00e-06 ***
tax          -0.011778   0.003372  -3.493 0.000521 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.736 on 494 degrees of freedom
Multiple R-squared:  0.7406,    Adjusted R-squared:  0.7348 
F-statistic: 128.2 on 11 and 494 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
</section>
<section id="最优子集选择-best-subset-selection" class="level4">
<h4 class="anchored" data-anchor-id="最优子集选择-best-subset-selection">最优子集选择 (Best Subset Selection)</h4>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
最优子集选择
</div>
</div>
<div class="callout-body-container callout-body">
<p>最优子集选择方法会考虑所有可能的模型组合，从中选择基于某些标准（如AIC、BIC、调整R²等）的最优模型。这种方法在计算上比逐步回归更为密集，但能找到全局最优解。</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用leaps包进行最优子集选择</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaps)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 执行最优子集选择</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>subsets <span class="ot">&lt;-</span> <span class="fu">regsubsets</span>(medv <span class="sc">~</span> ., <span class="at">data =</span> Boston, <span class="at">nvmax =</span> <span class="dv">13</span>)  <span class="co"># 最多考虑13个变量</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>subset_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(subsets)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 比较不同标准下的最佳模型</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(subset_summary<span class="sc">$</span>rss, <span class="at">xlab =</span> <span class="st">"变量数量"</span>, <span class="at">ylab =</span> <span class="st">"RSS"</span>, <span class="at">type =</span> <span class="st">"b"</span>)</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(subset_summary<span class="sc">$</span>adjr2, <span class="at">xlab =</span> <span class="st">"变量数量"</span>, <span class="at">ylab =</span> <span class="st">"调整R²"</span>, <span class="at">type =</span> <span class="st">"b"</span>)</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="fu">which.max</span>(subset_summary<span class="sc">$</span>adjr2), subset_summary<span class="sc">$</span>adjr2[<span class="fu">which.max</span>(subset_summary<span class="sc">$</span>adjr2)], </span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">cex =</span> <span class="dv">2</span>, <span class="at">pch =</span> <span class="dv">20</span>)</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(subset_summary<span class="sc">$</span>cp, <span class="at">xlab =</span> <span class="st">"变量数量"</span>, <span class="at">ylab =</span> <span class="st">"Cp"</span>, <span class="at">type =</span> <span class="st">"b"</span>)</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="fu">which.min</span>(subset_summary<span class="sc">$</span>cp), subset_summary<span class="sc">$</span>cp[<span class="fu">which.min</span>(subset_summary<span class="sc">$</span>cp)], </span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">cex =</span> <span class="dv">2</span>, <span class="at">pch =</span> <span class="dv">20</span>)</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(subset_summary<span class="sc">$</span>bic, <span class="at">xlab =</span> <span class="st">"变量数量"</span>, <span class="at">ylab =</span> <span class="st">"BIC"</span>, <span class="at">type =</span> <span class="st">"b"</span>)</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="fu">which.min</span>(subset_summary<span class="sc">$</span>bic), subset_summary<span class="sc">$</span>bic[<span class="fu">which.min</span>(subset_summary<span class="sc">$</span>bic)], </span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">cex =</span> <span class="dv">2</span>, <span class="at">pch =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看各标准下的最佳模型</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"调整R²最大的模型包含"</span>, <span class="fu">which.max</span>(subset_summary<span class="sc">$</span>adjr2), <span class="st">"个变量</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>调整R²最大的模型包含 11 个变量</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Cp最小的模型包含"</span>, <span class="fu">which.min</span>(subset_summary<span class="sc">$</span>cp), <span class="st">"个变量</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cp最小的模型包含 11 个变量</code></pre>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"BIC最小的模型包含"</span>, <span class="fu">which.min</span>(subset_summary<span class="sc">$</span>bic), <span class="st">"个变量</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BIC最小的模型包含 11 个变量</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 展示BIC最小模型的变量</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(subsets, <span class="fu">which.min</span>(subset_summary<span class="sc">$</span>bic))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  (Intercept)          crim            zn          chas           nox 
 36.341145004  -0.108413345   0.045844929   2.718716303 -17.376023429 
           rm           dis           rad           tax       ptratio 
  3.801578840  -1.492711460   0.299608454  -0.011777973  -0.946524570 
        black         lstat 
  0.009290845  -0.522553457 </code></pre>
</div>
</div>
</section>
<section id="正则化方法" class="level4">
<h4 class="anchored" data-anchor-id="正则化方法">正则化方法</h4>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
正则化方法的优势
</div>
</div>
<div class="callout-body-container callout-body">
<p>传统变量选择方法（如逐步回归和最优子集）存在一些局限性，如过拟合风险和不稳定性。正则化方法通过在模型中加入惩罚项，可以同时进行变量选择和系数收缩，解决这些问题。</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
1. 岭回归 (Ridge Regression)
</div>
</div>
<div class="callout-body-container callout-body">
<p>岭回归通过添加基于系数平方和的惩罚项(<span class="math inline">\(L_2\)</span>范数)来控制系数大小，适用于处理多重共线性。岭回归不会将系数精确压缩到零，因此不直接进行变量选择，但可以显著减小无关变量的影响。</p>
<p><span class="math display">\[\min_{\beta} \left\{ \sum_{i=1}^{n} (y_i - \beta_0 - \sum_{j=1}^{p} \beta_j x_{ij})^2 + \lambda \sum_{j=1}^{p} \beta_j^2 \right\}\]</span></p>
<p>其中<span class="math inline">\(\lambda\)</span>是调节惩罚强度的参数。</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 岭回归示例</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 准备数据</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(Boston[, <span class="sc">-</span><span class="dv">14</span>])  <span class="co"># 不包括medv变量的所有特征</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> Boston<span class="sc">$</span>medv</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 执行岭回归</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>ridge_cv <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(x, y, <span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">nfolds =</span> <span class="dv">10</span>)  <span class="co"># alpha=0表示岭回归</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制交叉验证结果</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ridge_cv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 最优lambda值</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>best_lambda_ridge <span class="ot">&lt;-</span> ridge_cv<span class="sc">$</span>lambda.min</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"岭回归的最优lambda值:"</span>, best_lambda_ridge, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>岭回归的最优lambda值: 0.6777654 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用最优lambda拟合模型</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>ridge_model <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(x, y, <span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">lambda =</span> best_lambda_ridge)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>ridge_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(ridge_model)</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ridge_coef)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>14 x 1 sparse Matrix of class "dgCMatrix"
                       s0
(Intercept)  28.051686825
crim         -0.087904300
zn            0.032606201
indus        -0.038328191
chas          2.902980774
nox         -12.005369287
rm            4.014163735
age          -0.003862644
dis          -1.120903830
rad           0.154161048
tax          -0.005729860
ptratio      -0.855862908
black         0.009068108
lstat        -0.471596371</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制系数变化路径</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>lambda_seq <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="fu">seq</span>(<span class="dv">2</span>, <span class="sc">-</span><span class="dv">3</span>, <span class="at">length =</span> <span class="dv">100</span>)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>ridge_path <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(x, y, <span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">lambda =</span> lambda_seq)</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ridge_path, <span class="at">xvar =</span> <span class="st">"lambda"</span>, <span class="at">label =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
2. Lasso回归 (Least Absolute Shrinkage and Selection Operator)
</div>
</div>
<div class="callout-body-container callout-body">
<p>Lasso回归添加基于系数绝对值和的惩罚项(<span class="math inline">\(L_1\)</span>范数)，可以将某些系数精确压缩到零，从而实现变量选择。这使得Lasso特别适用于高维数据的特征选择。</p>
<p><span class="math display">\[\min_{\beta} \left\{ \sum_{i=1}^{n} (y_i - \beta_0 - \sum_{j=1}^{p} \beta_j x_{ij})^2 + \lambda \sum_{j=1}^{p} |\beta_j| \right\}\]</span></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lasso回归示例</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>lasso_cv <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(x, y, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">nfolds =</span> <span class="dv">10</span>)  <span class="co"># alpha=1表示Lasso回归</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制交叉验证结果</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lasso_cv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 最优lambda值</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>best_lambda_lasso <span class="ot">&lt;-</span> lasso_cv<span class="sc">$</span>lambda.min</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Lasso回归的最优lambda值:"</span>, best_lambda_lasso, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Lasso回归的最优lambda值: 0.02118502 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用最优lambda拟合模型</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>lasso_model <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(x, y, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">lambda =</span> best_lambda_lasso)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>lasso_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(lasso_model)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 转换为矩阵后再进行操作</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>lasso_coef_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(lasso_coef)</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>selected_vars <span class="ot">&lt;-</span> <span class="fu">rownames</span>(lasso_coef_matrix)[lasso_coef_matrix <span class="sc">!=</span> <span class="dv">0</span>][<span class="sc">-</span><span class="dv">1</span>]  <span class="co"># 去掉截距项</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Lasso选择的变量:"</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Lasso选择的变量: crim, zn, chas, nox, rm, dis, rad, tax, ptratio, black, lstat </code></pre>
</div>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制系数变化路径</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>lasso_path <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(x, y, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">lambda =</span> lambda_seq)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lasso_path, <span class="at">xvar =</span> <span class="st">"lambda"</span>, <span class="at">label =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-15-2.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
3. 弹性网络 (Elastic Net)
</div>
</div>
<div class="callout-body-container callout-body">
<p>弹性网络结合了岭回归和Lasso回归的优点，同时使用<span class="math inline">\(L_1\)</span>和<span class="math inline">\(L_2\)</span>惩罚项。这种方法在处理高度相关变量时比Lasso更稳定，并保留了Lasso的变量选择能力。</p>
<p><span class="math display">\[\min_{\beta} \left\{ \sum_{i=1}^{n} (y_i - \beta_0 - \sum_{j=1}^{p} \beta_j x_{ij})^2 + \lambda \left[ (1-\alpha) \sum_{j=1}^{p} \beta_j^2 + \alpha \sum_{j=1}^{p} |\beta_j| \right] \right\}\]</span></p>
<p>其中<span class="math inline">\(\alpha\)</span>是混合参数，控制<span class="math inline">\(L_1\)</span>和<span class="math inline">\(L_2\)</span>惩罚的比例。</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 弹性网络示例</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>elastic_cv <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(x, y, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">nfolds =</span> <span class="dv">10</span>)  <span class="co"># alpha=0.5表示弹性网络</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制交叉验证结果</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(elastic_cv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 最优lambda值</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>best_lambda_elastic <span class="ot">&lt;-</span> elastic_cv<span class="sc">$</span>lambda.min</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"弹性网络的最优lambda值:"</span>, best_lambda_elastic, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>弹性网络的最优lambda值: 0.038606 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用最优lambda拟合模型</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>elastic_model <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(x, y, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">lambda =</span> best_lambda_elastic)</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>elastic_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(elastic_model)</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 转换为矩阵后再进行操作</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>elastic_coef_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(elastic_coef)</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算非零系数的数量</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>elastic_non_zero <span class="ot">&lt;-</span> <span class="fu">sum</span>(elastic_coef_matrix[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"弹性网络选择的变量数量:"</span>, elastic_non_zero, <span class="st">"个</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>弹性网络选择的变量数量: 11 个</code></pre>
</div>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 显示选择的变量</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>elastic_selected_vars <span class="ot">&lt;-</span> <span class="fu">rownames</span>(elastic_coef_matrix)[elastic_coef_matrix <span class="sc">!=</span> <span class="dv">0</span>][<span class="sc">-</span><span class="dv">1</span>]  <span class="co"># 去掉截距项</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"弹性网络选择的变量:"</span>, <span class="fu">paste</span>(elastic_selected_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>弹性网络选择的变量: crim, zn, chas, nox, rm, dis, rad, tax, ptratio, black, lstat </code></pre>
</div>
</div>
</section>
</section>
<section id="变量选择方法的比较" class="level3">
<h3 class="anchored" data-anchor-id="变量选择方法的比较">变量选择方法的比较</h3>
<p>不同的变量选择方法各有优缺点，可能会选出不同的变量组合。下面我们比较一下前面介绍的几种方法：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 预处理数据，为交叉验证作准备</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>train_idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(Boston), <span class="fl">0.7</span> <span class="sc">*</span> <span class="fu">nrow</span>(Boston))</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> Boston[train_idx, ]</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> Boston[<span class="sc">-</span>train_idx, ]</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 在训练集上拟合不同的模型</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. 完整模型</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>train_full <span class="ot">&lt;-</span> <span class="fu">lm</span>(medv <span class="sc">~</span> ., <span class="at">data =</span> train_data)</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. 向前逐步回归</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>train_forward <span class="ot">&lt;-</span> <span class="fu">step</span>(<span class="fu">lm</span>(medv <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> train_data), </span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">scope =</span> <span class="fu">list</span>(<span class="at">lower =</span> <span class="fu">lm</span>(medv <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> train_data), </span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">upper =</span> <span class="fu">lm</span>(medv <span class="sc">~</span> ., <span class="at">data =</span> train_data)), </span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">direction =</span> <span class="st">"forward"</span>, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. 准备Lasso和弹性网络的数据</span></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>x_train <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(train_data[, <span class="sc">-</span><span class="dv">14</span>])  <span class="co"># 不包括medv的所有特征</span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">&lt;-</span> train_data<span class="sc">$</span>medv</span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>x_test <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test_data[, <span class="sc">-</span><span class="dv">14</span>])</span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 拟合Lasso模型</span></span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>lasso_cv <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(x_train, y_train, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">nfolds =</span> <span class="dv">10</span>)</span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a>train_lasso <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(x_train, y_train, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">lambda =</span> lasso_cv<span class="sc">$</span>lambda.min)</span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 拟合弹性网络模型</span></span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a>elastic_cv <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(x_train, y_train, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">nfolds =</span> <span class="dv">10</span>)</span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a>train_elastic <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(x_train, y_train, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">lambda =</span> elastic_cv<span class="sc">$</span>lambda.min)</span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 在测试集上评估模型</span></span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true" tabindex="-1"></a>pred_full <span class="ot">&lt;-</span> <span class="fu">predict</span>(train_full, <span class="at">newdata =</span> test_data)</span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true" tabindex="-1"></a>pred_forward <span class="ot">&lt;-</span> <span class="fu">predict</span>(train_forward, <span class="at">newdata =</span> test_data)</span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true" tabindex="-1"></a>pred_lasso <span class="ot">&lt;-</span> <span class="fu">predict</span>(train_lasso, <span class="at">newx =</span> x_test)</span>
<span id="cb110-36"><a href="#cb110-36" aria-hidden="true" tabindex="-1"></a>pred_elastic <span class="ot">&lt;-</span> <span class="fu">predict</span>(train_elastic, <span class="at">newx =</span> x_test)</span>
<span id="cb110-37"><a href="#cb110-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-38"><a href="#cb110-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算测试集上的RMSE</span></span>
<span id="cb110-39"><a href="#cb110-39" aria-hidden="true" tabindex="-1"></a>rmse_full <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((test_data<span class="sc">$</span>medv <span class="sc">-</span> pred_full)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb110-40"><a href="#cb110-40" aria-hidden="true" tabindex="-1"></a>rmse_forward <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((test_data<span class="sc">$</span>medv <span class="sc">-</span> pred_forward)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb110-41"><a href="#cb110-41" aria-hidden="true" tabindex="-1"></a>rmse_lasso <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((test_data<span class="sc">$</span>medv <span class="sc">-</span> pred_lasso)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb110-42"><a href="#cb110-42" aria-hidden="true" tabindex="-1"></a>rmse_elastic <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((test_data<span class="sc">$</span>medv <span class="sc">-</span> pred_elastic)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb110-43"><a href="#cb110-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-44"><a href="#cb110-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算各模型选择的变量数量</span></span>
<span id="cb110-45"><a href="#cb110-45" aria-hidden="true" tabindex="-1"></a>lasso_coef_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">coef</span>(train_lasso))</span>
<span id="cb110-46"><a href="#cb110-46" aria-hidden="true" tabindex="-1"></a>elastic_coef_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">coef</span>(train_elastic))</span>
<span id="cb110-47"><a href="#cb110-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-48"><a href="#cb110-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 比较结果</span></span>
<span id="cb110-49"><a href="#cb110-49" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb110-50"><a href="#cb110-50" aria-hidden="true" tabindex="-1"></a>  模型 <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"完整模型"</span>, <span class="st">"向前逐步回归"</span>, <span class="st">"Lasso回归"</span>, <span class="st">"弹性网络"</span>),</span>
<span id="cb110-51"><a href="#cb110-51" aria-hidden="true" tabindex="-1"></a>  变量数 <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">length</span>(<span class="fu">coef</span>(train_full)) <span class="sc">-</span> <span class="dv">1</span>, </span>
<span id="cb110-52"><a href="#cb110-52" aria-hidden="true" tabindex="-1"></a>            <span class="fu">length</span>(<span class="fu">coef</span>(train_forward)) <span class="sc">-</span> <span class="dv">1</span>, </span>
<span id="cb110-53"><a href="#cb110-53" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sum</span>(lasso_coef_matrix[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>),</span>
<span id="cb110-54"><a href="#cb110-54" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sum</span>(elastic_coef_matrix[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>)),</span>
<span id="cb110-55"><a href="#cb110-55" aria-hidden="true" tabindex="-1"></a>  测试集<span class="at">RMSE =</span> <span class="fu">c</span>(rmse_full, rmse_forward, rmse_lasso, rmse_elastic)</span>
<span id="cb110-56"><a href="#cb110-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb110-57"><a href="#cb110-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-58"><a href="#cb110-58" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          模型 变量数 测试集RMSE
1     完整模型     13   4.802811
2 向前逐步回归     11   4.772547
3    Lasso回归     13   4.803306
4     弹性网络     13   4.803614</code></pre>
</div>
</div>
</section>
<section id="变量重要性可视化" class="level3">
<h3 class="anchored" data-anchor-id="变量重要性可视化">变量重要性可视化</h3>
<p>变量重要性可视化可以帮助我们直观地了解各个变量对模型的贡献程度：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 向前逐步回归的变量重要性</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>coef_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  变量 <span class="ot">=</span> <span class="fu">names</span>(<span class="fu">coef</span>(train_forward))[<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  系数 <span class="ot">=</span> <span class="fu">coef</span>(train_forward)[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>coef_data <span class="ot">&lt;-</span> coef_data[<span class="fu">order</span>(<span class="fu">abs</span>(coef_data<span class="sc">$</span>系数), <span class="at">decreasing =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(coef_data, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(变量, <span class="fu">abs</span>(系数)), <span class="at">y =</span> 系数)) <span class="sc">+</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"向前逐步回归选择的变量重要性"</span>,</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"变量"</span>,</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"系数"</span>) <span class="sc">+</span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lasso回归的变量重要性</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>lasso_coef_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>  变量 <span class="ot">=</span> <span class="fu">rownames</span>(lasso_coef_matrix)[<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>  系数 <span class="ot">=</span> lasso_coef_matrix[<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>lasso_coef_data <span class="ot">&lt;-</span> lasso_coef_data[<span class="fu">order</span>(<span class="fu">abs</span>(lasso_coef_data<span class="sc">$</span>系数), <span class="at">decreasing =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>lasso_coef_data <span class="ot">&lt;-</span> lasso_coef_data[lasso_coef_data<span class="sc">$</span>系数 <span class="sc">!=</span> <span class="dv">0</span>, ]  <span class="co"># 只保留非零系数</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(lasso_coef_data, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(变量, <span class="fu">abs</span>(系数)), <span class="at">y =</span> 系数)) <span class="sc">+</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"darkred"</span>) <span class="sc">+</span></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Lasso回归选择的变量重要性"</span>,</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"变量"</span>,</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"系数"</span>) <span class="sc">+</span></span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week6_files/figure-html/unnamed-chunk-18-2.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="变量选择标准" class="level3">
<h3 class="anchored" data-anchor-id="变量选择标准">变量选择标准</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
变量选择的标准
</div>
</div>
<div class="callout-body-container callout-body">
<p>在变量选择过程中，我们需要考虑以下几个标准：</p>
<ol type="1">
<li><strong>解释力</strong>：选择对因变量有显著影响的变量，以提高模型的解释力。</li>
<li><strong>简洁性</strong>：选择尽可能少的变量，以简化模型并避免过拟合。</li>
<li><strong>稳定性</strong>：选择对样本变化不敏感的变量，以提高模型的稳定性。</li>
<li><strong>预测能力</strong>：选择对新数据有良好预测能力的变量，以提高模型的泛化能力。</li>
</ol>
<p>这些标准需要在变量选择过程中进行权衡，以找到最优的变量组合。</p>
</div>
</div>
<div class="callout callout-style-simple callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
AI辅助学习建议（第六周）
</div>
</div>
<div class="callout-body-container callout-body">
<section id="回归分析理解与解释" class="level3">
<h3 class="anchored" data-anchor-id="回归分析理解与解释">回归分析理解与解释</h3>
<ul>
<li><strong>请AI解释回归系数的含义</strong>：要求AI使用通俗易懂的语言解释回归系数的实际意义</li>
<li><strong>让AI比较相关分析与回归分析</strong>：理解两者的区别和各自适用场景</li>
<li><strong>要求AI解释拟合优度(R²)</strong>：深入理解R²的含义、局限性和在商业分析中的解读方式</li>
</ul>
</section>
<section id="r代码编写与模型构建" class="level3">
<h3 class="anchored" data-anchor-id="r代码编写与模型构建">R代码编写与模型构建</h3>
<ul>
<li><strong>请AI生成完整的回归分析流程代码</strong>：从数据探索、模型构建到诊断和解释的全流程代码</li>
<li><strong>让AI帮助进行变量选择</strong>：生成向前、向后或逐步回归代码，并解释选择逻辑</li>
<li><strong>要求AI编写回归结果可视化代码</strong>：创建更专业和直观的回归结果展示图</li>
</ul>
</section>
<section id="回归模型诊断与优化" class="level3">
<h3 class="anchored" data-anchor-id="回归模型诊断与优化">回归模型诊断与优化</h3>
<ul>
<li><strong>请AI检查回归模型假设</strong>：生成检验线性性、同方差性、独立性和正态性的代码和解释</li>
<li><strong>让AI解释多重共线性问题</strong>：诊断和处理多重共线性的方法</li>
<li><strong>要求AI优化模型预测性能</strong>：提供提高模型预测准确性的建议</li>
</ul>
</section>
<section id="回归分析应用场景" class="level3">
<h3 class="anchored" data-anchor-id="回归分析应用场景">回归分析应用场景</h3>
<ul>
<li><strong>请AI推荐适合项目主题的回归应用问题</strong>：根据选择的项目主题获取具体的研究问题建议</li>
<li><strong>让AI设计商业分析方案</strong>：设计从数据收集到分析解释的完整方案</li>
<li><strong>要求AI解释回归分析在不同行业的应用</strong>：了解回归分析在市场营销、金融、人力资源等领域的典型应用案例</li>
</ul>
</section>
</div>
</div>
</section>
<section id="参考文献与扩展阅读" class="level3">
<h3 class="anchored" data-anchor-id="参考文献与扩展阅读">参考文献与扩展阅读</h3>
<ol type="1">
<li>James, G., Witten, D., Hastie, T., &amp; Tibshirani, R. (2013). An Introduction to Statistical Learning. Springer.</li>
<li>Kutner, M. H., Nachtsheim, C. J., Neter, J., &amp; Li, W. (2005). Applied Linear Statistical Models (5th ed.). McGraw-Hill.</li>
<li>Fox, J. (2016). Applied Regression Analysis and Generalized Linear Models (3rd ed.). SAGE Publications.</li>
<li>Faraway, J. J. (2014). Linear Models with R (2nd ed.). Chapman and Hall/CRC.</li>
<li>李惠莲. (2018). 回归分析在商业决策中的应用. 统计与决策, 34(15), 82-85.</li>
</ol>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./week5.html" class="pagination-link" aria-label="第五周：方差分析">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-title">第五周：方差分析</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./week7.html" class="pagination-link" aria-label="第七周：分类数据分析">
        <span class="nav-page-text"><span class="chapter-title">第七周：分类数据分析</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>