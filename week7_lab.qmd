---
title: "第七周实验：卡方检验与统计方法选择"
execute:
  echo: true
  message: false
  warning: false
  error: false
  cache: false
---

## 1. 目标

本实验旨在练习处理分类数据，特别是使用列联表和卡方检验来分析两个分类变量之间的关联性，并巩固根据研究问题选择合适统计方法的能力。

-   使用 `table()` 创建列联表，并使用 `prop.table()` 计算百分比。
-   使用 `chisq.test()` 执行卡方独立性检验。
-   检查卡方检验的期望频数假设。
-   解读卡方检验的结果（$\chi^2$ 值, df, P 值）。
-   (可选) 了解并使用 `fisher.test()`。
-   练习根据不同场景选择合适的统计检验方法（回顾阶段一内容）。

## 2. 数据准备

我们将使用 `ggplot2` 内置的 `diamonds` 数据集，并可能创建一些模拟数据。

```r
library(tidyverse)

# 使用 diamonds 数据集
# 为了避免样本量过大导致期望频数都很大，我们抽取一个子集
set.seed(123)
diamonds_subset <- diamonds %>% sample_n(1000)

# 查看数据结构和变量类型
glimpse(diamonds_subset)
# 我们将重点关注 cut (切割质量) 和 color (颜色) 这两个分类变量
```

## 3. 列联表分析

**任务:** 

1. 使用 `table()` 函数创建 `diamonds_subset` 数据集中 `cut` 和 `color` 变量的列联表，存储在 `cut_color_table` 中并打印。 
2. 使用 `prop.table()` 计算该列联表的： 
    -   单元格占总数的百分比。 
    -   行百分比 (每行的和为 100%)。 
    -   列百分比 (每列的和为 100%)。 
3. **解读:** 根据行百分比或列百分比，初步判断 `cut` 和 `color` 之间是否存在某种关联的迹象？（例如，某个切割等级是否更倾向于出现某种颜色？）


## 4. 卡方独立性检验 (`chisq.test`)

**场景:** 我们想正式检验钻石的切割质量 (`cut`) 与颜色 (`color`) 是否相互独立。

**任务:** 

1. 陈述卡方独立性检验的原假设 ($H_0$) 和备择假设 ($H_1$)。
2. 使用 `chisq.test()` 对 `cut_color_table` 进行卡方检验。
3. **检查期望频数假设:** 从检验结果中提取期望频数 (`$expected`)，检查是否有期望频数小于 5 的单元格？如果有很多，卡方检验的 P 值可能不准确。
4. 解读检验结果：$\chi^2$ 统计量值、自由度 (df)、P 值。
5. 根据 P 值和 $\alpha = 0.05$ 做出决策。
6. 用通俗语言解释结论。


## 5. (可选) Fisher 精确检验 (`fisher.test`)

**场景:** 假设我们有一个 2x2 的列联表，或者卡方检验的期望频数假设不满足。

**模拟 2x2 数据:** 假设我们调查了 30 人是否使用某 APP（UseApp: Yes/No）以及他们的性别（Gender: Male/Female）。

```r
set.seed(999)

gender <- sample(c("Male", "Female"), 30, replace = TRUE)
use_app <- sample(c("Yes", "No"), 30, replace = TRUE, prob = c(0.6, 0.4))

app_gender_table <- table(Gender = gender, UseApp = use_app)

print(app_gender_table)
```

**任务:**

1. 对 `app_gender_table` 执行 Fisher 精确检验。
2. 解读 P 值并做出结论。


## 6. 统计方法选择练习

根据以下场景，选择最合适的统计检验或分析方法，并简要说明理由。

1.  **场景一:** 比较两种不同品牌（A 和 B）灯泡的平均使用寿命（单位：小时）。收集了两组独立样本数据。
2.  **场景二:** 调查某大学学生对新图书馆规章的满意度（分为：非常满意、满意、一般、不满意、非常不满意）是否与其所在学院（文学院、理学院、工学院、商学院）有关。
3.  **场景三:** 研究跑步距离（公里）与跑步者消耗的卡路里（大卡）之间的关系强度和方向。
4.  **场景四:** 一家公司想知道其新推出的广告（花费：万元）是否显著提升了产品月销量（件）。他们有广告投放前 12 个月和投放后 12 个月的月销量数据。
5.  **场景五:** 检验一个标准的六面骰子是否是公平的（即每个点数出现的概率是否都是 1/6）。进行了 600 次投掷。
6.  **场景六:** 想要预测一个客户是否会购买某产品（是/否），基于该客户的年龄、收入和历史购买次数。
7.  **场景七:** 比较三种不同施肥方案（方案 1、方案 2、对照组）对玉米平均产量的影响。
8.  **场景八:** 检验一批产品的实际重量（克）是否显著低于其标注重量 500 克。


## 7. 实验总结

在本实验中，我们重点练习了处理分类变量关联性的主要工具——列联表和卡方独立性检验。我们学会了如何创建表格、计算百分比、执行检验、检查假设并解读结果。我们还了解了 Fisher 精确检验的适用场景。最后，通过场景分析，我们巩固了根据研究问题和数据类型选择合适统计方法的能力，这是整个第一阶段学习的核心技能之一。