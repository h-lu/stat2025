---
title: "第七周：分类数据分析"
---

# 1. 学习目标 {.unnumbered}

在本周的学习中，你将：

*   理解分类数据分析的基本概念和适用场景。
*   掌握卡方检验（Chi-squared Test）的原理、类型（拟合优度、独立性）和应用。
*   掌握相关分析（Correlation Analysis）的原理，特别是 Pearson 和 Spearman 相关系数的应用和区别。
*   能够使用 R 语言进行卡方检验和相关分析，并解释结果。
*   通过案例分析，将分类数据分析方法应用于解决实际的经管问题。

# 2. 引入：为何关注分类数据？

在经济管理领域，我们经常遇到分类型变量（Categorical Variables），例如：

*   **用户特征：** 性别（男/女）、会员等级（普通/银卡/金卡）、购买意愿（是/否）
*   **产品特征：** 产品类别（A/B/C）、包装类型（精装/简装）、评价等级（好/中/差）
*   **市场调研：** 品牌偏好（品牌1/品牌2/品牌3）、广告渠道（线上/线下/社交媒体）
*   **经营决策：** 促销策略（折扣/赠品/满减）、员工满意度（满意/一般/不满意）

与连续型数据（如销售额、身高、体重）不同，分类数据的分析需要特定的统计方法。本周我们将学习两种核心的分析技术：**卡方检验** 和 **相关分析**。

::: {.callout-tip}
## 思考与讨论 (小组活动 - 5分钟)

1.  在你所选的项目主题（项目一或项目二）中，有哪些是分类变量？
2.  你认为分析这些分类变量可以帮助你回答哪些研究问题？

请与小组成员讨论，并准备分享你们的想法。
:::

# 3. 卡方检验 (Chi-squared Test, χ²)

卡方检验是一种用途广泛的假设检验方法，主要用于分析**分类变量**之间的关系。它比较**观测频数**（Observed Frequencies）和**期望频数**（Expected Frequencies）之间的差异。

期望频数是在**原假设 (H0) 为真**的情况下，我们预期在各个类别中出现的频数。

卡方检验主要有两种类型：

*   **拟合优度检验 (Goodness-of-Fit Test):** 检验**单个**分类变量的观测频数分布是否与**理论或期望**的分布拟合。
*   **独立性检验 (Test for Independence):** 检验**两个**分类变量之间是否**相互独立**。

## 3.1 拟合优度检验 (Goodness-of-Fit Test)

**目标：** 判断一个分类变量的观测频数分布是否符合某个预期的理论分布。

**例子：**

*   一家公司声称其生产的四种口味（A, B, C, D）的饮料销量是均等的。我们抽取了一批样本，想检验这个说法是否属实。
*   根据历史数据，某网站用户的来源分布为：搜索引擎 40%，社交媒体 30%，直接访问 20%，其他 10%。我们想检验当前的用户来源分布是否发生了显著变化。

**假设：**

*   H0: 观测频数分布**符合**期望分布。
*   H1: 观测频数分布**不符合**期望分布。

**检验统计量：**

$$\chi^2 = \sum \frac{(O_i - E_i)^2}{E_i}$$
其中：

*   $O_i$ 是第 i 个类别的观测频数。
*   $E_i$ 是第 i 个类别的期望频数。
*   自由度 (df) = k - 1，k 是类别数量。

**判断：** 计算出的 χ² 值越大，表示观测与期望的差异越大，越倾向于拒绝 H0。将 χ² 值与临界值比较，或查看 p 值。如果 p 值小于显著性水平 α (通常取 0.05)，则拒绝 H0。

**R 语言实现：** 使用 `stats` 包中的 `chisq.test()` 函数。

```r
# 示例1：检验四种口味饮料销量是否均等
# 观测销量
observed_sales <- c(A = 85, B = 95, C = 110, D = 110) 
# 期望比例 (均等，即各占 1/4)
expected_prop <- c(0.25, 0.25, 0.25, 0.25)

# 执行拟合优度检验
# 注意：如果期望比例不指定 (p=...)，默认检验是否均匀分布
chisq_result_fit <- chisq.test(x = observed_sales, p = expected_prop) 
print(chisq_result_fit)

# 结果解读：
# 查看 p-value。如果 p < 0.05，则拒绝H0，认为销量分布不均等。
```

::: {.callout-note}
## R代码实践与解读 (个人/结对活动 - 10分钟)

1.  运行上述 R 代码。
2.  解读 `chisq.test()` 的输出结果：χ² 统计量、自由度、p 值分别是什么？
3.  根据 p 值，你得出的结论是什么？（即，四种口味饮料的销量真的是均等的吗？）
4.  **思考：** 如果期望的比例不是均等的（例如，公司期望 A:B:C:D 的比例是 2:3:3:2），代码应该如何修改？尝试修改并运行。
:::

## 3.2 独立性检验 (Test for Independence)

**目标：** 判断两个分类变量之间是否存在关联，即它们是否相互独立。

**例子：**

*   研究不同**性别**（男/女）与**购买意愿**（购买/不购买）之间是否存在关系？
*   分析不同**广告渠道**（线上/线下/社交媒体）对**品牌认知度**（知道/不知道）的影响是否不同？
*   检验**学历水平**（本科/硕士/博士）与**工作满意度**（满意/一般/不满意）是否相关？

**数据形式：** 通常用**列联表 (Contingency Table)** 来展示两个分类变量的交叉频数。

|           | 购买 | 不购买 | 总计 |
| :-------- | :--- | :----- | :--- |
| **男性**  | 150  | 100    | 250  |
| **女性**  | 200  | 50     | 250  |
| **总计**  | 350  | 150    | 500  |

**假设：**

*   H0: 两个变量**相互独立** (没有关联)。
*   H1: 两个变量**不相互独立** (存在关联)。

**期望频数计算：** 在独立性假设下，某个单元格 (第 r 行, 第 c 列) 的期望频数 $E_{rc}$ 为：

$$E_{rc} = \frac{(\text{第 r 行总计}) \times (\text{第 c 列总计})}{\text{总样本量}}$$

**检验统计量：**

$$\chi^2 = \sum_{r,c} \frac{(O_{rc} - E_{rc})^2}{E_{rc}}$$

其中：

*   $O_{rc}$ 是第 r 行、第 c 列单元格的观测频数。
*   $E_{rc}$ 是第 r 行、第 c 列单元格的期望频数。
*   自由度 (df) = (行数 - 1) * (列数 - 1)。

**判断：** 与拟合优度检验类似，比较 χ² 值与临界值，或查看 p 值。如果 p 值小于 α，则拒绝 H0，认为两个变量之间存在关联。

**R 语言实现：** 同样使用 `chisq.test()` 函数，输入数据为列联表（矩阵或 `table` 对象）。

```r
# 示例2：检验性别与购买意愿是否独立
library(tidyverse)
library(janitor)

# 使用 tibble 创建数据
contingency_data <- tibble(
  Gender = rep(c("Male", "Female"), times = c(150+100, 200+50)),
  Purchase = c(rep("Yes", 150), rep("No", 100), rep("Yes", 200), rep("No", 50))
)

# 使用 janitor::tabyl 创建列联表
contingency_table <- contingency_data %>%
  tabyl(Gender, Purchase)
print("列联表:")
print(contingency_table)

# 执行独立性检验
chisq_result_indep <- chisq.test(contingency_table)
print(chisq_result_indep)

# 结果解读：
# 查看 p-value。如果 p < 0.05，则拒绝H0，认为性别与购买意愿之间存在关联（不独立）。
# 注意：chisq.test 可能会给出关于期望频数过小的警告 (Warning)，
# 当有单元格期望频数 < 5 时，卡方检验的近似可能不准确，
# 可以考虑 Fisher's Exact Test (fisher.test()) 或合并类别。
```

::: {.callout-tip}
## 案例分析与讨论 (小组活动 - 15分钟)

假设你正在进行一项市场调研，分析不同年龄段（青年/中年/老年）对三种不同促销策略（折扣/赠品/满减）的偏好是否存在差异。你收集了以下数据：

| 年龄段 | 折扣 | 赠品 | 满减 |
| :----- | :--- | :--- | :--- |
| 青年   | 50   | 30   | 20   |
| 中年   | 40   | 50   | 30   |
| 老年   | 20   | 30   | 50   |

1.  **构建假设：** 写出该问题的原假设 (H0) 和备择假设 (H1)。
2.  **数据输入：** 在 R 中创建这个列联表。
3.  **执行检验：** 使用 `chisq.test()` 进行独立性检验。
4.  **结果解释：**
    *   p 值是多少？
    *   你的结论是什么？年龄段和促销策略偏好是否相关？
    *   **深入思考：** 如果检验结果显著（即 p < 0.05），这仅仅说明了“存在关联”。我们如何知道具体是哪些年龄段对哪些策略有特别的偏好或不偏好？ (提示：查看检验结果中的 `observed` 和 `expected` 值，或者 `residuals` 残差)。

请小组合作完成，并准备分享你们的分析过程和结论。
:::

# 4. 相关分析 (Correlation Analysis)

相关分析用于研究**两个变量**之间**线性关系**的**强度**和**方向**。

*   **强度 (Strength):** 关系有多紧密？（例如，强相关、弱相关、无相关）
*   **方向 (Direction):** 一个变量增加时，另一个变量是倾向于增加（正相关）还是减少（负相关）？

常用的相关系数：

*   **Pearson 相关系数 (r):** 衡量两个**连续变量**之间**线性**关系的强度和方向。取值范围 [-1, 1]。
*   **Spearman 等级相关系数 (ρ 或 rs):** 衡量两个变量（可以是**连续**或**有序分类**变量）之间**单调关系**的强度和方向。它是基于数据的**秩 (Rank)** 计算的，对异常值不敏感，不要求数据呈正态分布。取值范围 [-1, 1]。

**如何选择？**

*   如果两个变量都是**连续**的，且关系近似**线性**，数据近似**正态分布**，优先考虑 **Pearson**。
*   如果至少有一个变量是**有序分类**的，或者两个连续变量的关系是**非线性但单调**的，或者数据**不服从正态分布**，或者存在**异常值**，优先考虑 **Spearman**。

**相关系数的解释：**

*   **接近 1:** 强正相关
*   **接近 -1:** 强负相关
*   **接近 0:** 弱相关或无线性/单调关系
*   **注意:** 相关性**不等于**因果关系！(Correlation does not imply causation!)

## 4.1 Pearson 相关系数 ($r$)

**假设：**

*   变量是连续的。
*   变量之间存在线性关系。
*   数据服从二元正态分布 (或各自近似正态分布)。
*   数据中没有显著的异常值。

**R 语言实现：** 使用 `stats` 包中的 `cor()` 或 `cor.test()` 函数。`cor.test()` 还会进行显著性检验。

```r
# 示例3：分析广告投入 (连续) 与 销售额 (连续) 的关系
sales_data <- tibble(
    advertising = c(10, 15, 12, 18, 20, 14, 16, 11, 19, 13),
    sales = c(80, 95, 88, 110, 120, 92, 105, 85, 115, 90)
)

# 绘制散点图初步观察关系
ggplot(sales_data, aes(x = advertising, y = sales)) +
    geom_point() +
    geom_smooth(method = "lm", se = FALSE) +
    labs(title = "广告投入 vs 销售额", x = "广告投入 (万元)", y = "销售额 (万元)")

# 计算 Pearson 相关系数并进行检验
pearson_test <- cor.test(sales_data$advertising, sales_data$sales, method = "pearson")
print(pearson_test)

# 结果解读：
# 查看 estimate (相关系数值 r) 和 p-value。
# r 值接近 1，表示强正相关。
# p < 0.05，表示相关性在统计上是显著的。
```

## 4.2 Spearman 等级相关系数 ($\rho$)

**适用场景：**

*   至少一个变量是有序分类的（例如，教育水平：小学/中学/大学；满意度：低/中/高）。
*   两个连续变量的关系是单调但非线性的。
*   连续变量数据不符合正态分布假设。
*   存在异常值。

**原理：** 先将每个变量的数据转换成**等级 (Rank)**，然后计算这些等级之间的 Pearson 相关系数。

**R 语言实现：** 在 `cor()` 或 `cor.test()` 函数中指定 `method = "spearman"`。

```r
# 示例4：分析 工作年限 (连续) 与 职位等级 (有序分类) 的关系
# 假设职位等级编码：1=初级, 2=中级, 3=高级
experience_data <- tibble(
    years_experience = c(1, 3, 2, 5, 8, 4, 6, 10, 7, 9),
    position_level = c(1, 1, 1, 2, 3, 2, 2, 3, 3, 3) 
)

# 由于 position_level 是有序分类变量，使用 Spearman
spearman_test <- cor.test(experience_data$years_experience, experience_data$position_level, method = "spearman")
print(spearman_test)

# 结果解读：
# 查看 estimate (相关系数值 rho) 和 p-value。
# rho > 0，表示正相关 (工作年限越长，职位等级倾向于越高)。
# p < 0.05，表示这种单调关系在统计上是显著的。
```

::: {.callout-info}
## Think-Pair-Share (5分钟)

1.  **思考：** 如果你想研究“冰淇淋销量”和“气温”之间的关系，你会选择 Pearson 还是 Spearman？为什么？
2.  **思考：** 如果你想研究“学生花在学习上的时间（等级：很少/中等/很多）”和“考试成绩（分数）”之间的关系，你会选择哪种相关系数？为什么？

先独立思考，然后与旁边同学交流你的想法。
:::

# 5. 综合案例：客户满意度分析

一家电商公司进行了一次客户满意度调查，收集了以下信息：

*   `Region`: 客户所在区域 (北方 / 华东 / 华南) - 分类
*   `Membership`: 会员等级 (普通 / 银卡 / 金卡) - 有序分类
*   `Satisfaction`: 总体满意度评分 (1-5分，1最低，5最高) - 有序分类 / 可近似作连续
*   `Spending`: 近半年消费金额 (元) - 连续

**分析任务：**

1.  检验**客户所在区域 (Region)** 与 **会员等级 (Membership)** 是否独立？
2.  分析**近半年消费金额 (Spending)** 与 **总体满意度评分 (Satisfaction)** 之间的相关性。

**数据 (示例)：**

```r
# 创建示例数据框
set.seed(123) # 为了结果可重复
customer_data <- tibble(
  Region = sample(c("北方", "华东", "华南"), 100, replace = TRUE, prob = c(0.3, 0.4, 0.3)),
  Membership = factor(sample(c("普通", "银卡", "金卡"), 100, replace = TRUE, prob = c(0.5, 0.3, 0.2)), 
                      levels = c("普通", "银卡", "金卡"), ordered = TRUE),
  Satisfaction = sample(1:5, 100, replace = TRUE, prob = c(0.1, 0.2, 0.4, 0.2, 0.1)),
  Spending = rnorm(100, mean = 1000, sd = 300) + rep(c(0, 100, 300), times = c(50, 30, 20))[match(sample(c("普通", "银卡", "金卡"), 100, replace = TRUE, prob = c(0.5, 0.3, 0.2)), c("普通", "银卡", "金卡"))] * 0.8 # 让消费和会员等级有点关系
)

# 确保 Spending 非负
customer_data$Spending <- pmax(customer_data$Spending, 50) 

head(customer_data)
summary(customer_data)
```

**分析过程 (R代码)：**

```r
# 任务1：检验 Region 与 Membership 是否独立

# 创建 Region 和 Membership 的列联表

# 执行卡方独立性检验

# 任务2：分析 Spending 与 Satisfaction 的相关性

# Satisfaction 是 1-5 的评分，可以看作有序分类，也可以近似看作连续。
# Spending 是连续变量。
# 考虑到 Satisfaction 的等级性质，优先选用 Spearman 相关性。
# 也可以计算 Pearson 作为对比，但要注意其假设。

# 绘制散点图 (注意 Satisfaction 是离散的，用 jitter 避免点重叠)

# 计算 Spearman 相关系数并检验

# (可选) 计算 Pearson 相关系数作为对比
```

::: {.callout-important}
## 案例解读与深化 (课堂讨论 - 15分钟)

1.  **任务1解读：**
    *   根据卡方检验的 p 值，你认为客户所在区域和会员等级之间有关联吗？
    *   如果有关联，观察列联表和卡方检验的期望频数（`chisq_test_region_membership$expected`），哪些区域的哪些会员等级的实际人数与期望人数差异较大？这可能意味着什么？
2.  **任务2解读：**
    *   根据 Spearman 相关系数和 p 值，消费金额和满意度之间是否存在显著的相关性？方向和强度如何？
    *   比较 Spearman 和 Pearson 的结果，在这个案例中它们是否有很大差异？为什么？
3.  **拓展思考：**
    *   除了上述分析，你还能提出哪些关于这些变量之间关系的问题？（例如，不同会员等级的满意度是否有差异？不同区域的消费金额是否有差异？）你会用什么统计方法来检验？（提示：可能需要用到上周或下周的内容，如 t 检验、ANOVA）
    *   **AI 辅助：** 如果你在解释卡方检验或相关性结果时遇到困难，尝试向 AI 提问，例如：“请解释卡方检验独立性检验的 p 值小于 0.05 意味着什么？” 或 “Spearman 相关系数 0.3 表示什么程度的相关性？”
:::

# 6. 总结与展望

本周我们学习了处理分类数据的两种重要方法：

*   **卡方检验：** 用于比较观测频数与期望频数，分析单个分类变量的分布（拟合优度）或两个分类变量的独立性。
*   **相关分析 (Pearson & Spearman):** 用于衡量两个变量之间线性或单调关系的强度和方向。

**关键点：**

*   正确选择检验方法取决于你的**研究问题**和**数据类型**。
*   理解检验的**假设**非常重要。
*   **相关性不等于因果性**。
*   熟练使用 R 语言的 `chisq.test()` 和 `cor.test()` 函数进行计算和解释结果。
