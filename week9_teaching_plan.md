# 第九周：回归模型诊断实战 - 详细授课计划

**周次:** 9
**主题:** 回归模型诊断：发现模型的问题
**总时长:** 180 分钟 (2 x 90 分钟)
**核心材料:** `week9_lecture.qmd`, `week9_lab.qmd`
**所需 R 包:** `tidyverse`, `ggplot2`, `car`, `broom`

**总体学习目标:**

*   理解线性回归模型诊断的必要性及其核心关注点（L.I.N.E. 假设、异常/影响点）。
*   掌握常用模型诊断工具的原理、R 实现及结果解读方法。
*   能够运用诊断工具评估模型拟合情况，识别潜在问题。
*   培养通过对比不同模型的诊断结果来加深理解的能力。

---

## 第一节课 (90 分钟): 模型诊断基础与核心图形分析

**目标:** 掌握模型诊断的基本概念，学会使用和解读残差图与正态 Q-Q 图，并了解正态性检验。

**时间** | **活动/内容** | **教学方法** | **关键点/强调内容** | **对应材料/代码** | **备注/互动**
|---|---|---|---|---|---|
| 0-5 分钟 | **课程导入与回顾** | 讲授, 提问 | - 简要回顾上周多元回归内容。 <br> - 提问：拟合模型后就结束了吗？为何要诊断？ | `week9_lecture.qmd` §1 | 激发思考 |
| 5-15 分钟 | **为何需要模型诊断？** | 讲授, 示例 | - L.I.N.E. 假设 (线性性, 独立性, 正态性, 等方差性)。 <br> - 异常值 (Outlier), 高杠杆点 (High Leverage), 强影响点 (Influential Point) 的概念区分。 <br> - 强调诊断是确保结果可靠性的关键。 | `week9_lecture.qmd` §1 | 清晰定义概念 |
| 15-20 分钟 | **准备工作与示例模型介绍** | 讲授, 代码演示 | - 加载所需 R 包 (`tidyverse`, `ggplot2`, `car`, `broom`)。 <br> - **重点介绍课堂演示模型:** `mlr_model_mpg` (基于 `mpg` 数据) 和 `prob_model` (包含已知问题的模拟数据)。 <br> - 运行代码生成这两个模型。 | `week9_lecture.qmd` §1 (代码块) | 确保学生环境设置正确，理解演示模型背景 |
| 20-45 分钟 | **诊断工具 1: 残差分析 (线性性与等方差性)** | 讲授, 图形解读, 代码演示 | - **残差概念:** $e_i = y_i - \hat{y}_i$。 <br> - **残差图 (Residuals vs Fitted):** <br>   - 横轴 (Fitted values), 纵轴 (Residuals)。 <br>   - **理想模式:** 随机散布在 $y=0$ 上下，无明显模式。 <br>   - **解读:** 如何通过图形判断**线性性**(无曲线)和**等方差性**(散点宽度一致，无喇叭形)。 <br> - **R 实现:** <br>   - `plot(model)` 第一个图。 <br>   - `broom::augment()` + `ggplot2` 手动绘制。 <br> - **演示:** 对 `mlr_model_mpg` 进行演示和解读。 | `week9_lecture.qmd` §2.1 (文字和代码块) | 强调图形解读技巧，对比理想与非理想模式 |
| 45-65 分钟 | **诊断工具 2: 残差正态性检查** | 讲授, 图形解读, 代码演示 | - **正态 Q-Q 图 (Normal Q-Q Plot):** <br>   - 横轴 (Theoretical Quantiles), 纵轴 (Standardized Residuals)。 <br>   - **理想模式:** 点大致落在对角线上。 <br>   - **解读:** 如何判断偏离 (S 形, 弓形)。 <br> - **R 实现:** <br>   - `plot(model)` 第二个图。 <br>   - `ggplot2::stat_qq()` 和 `stat_qq_line()`。 <br> - **演示:** 对 `mlr_model_mpg` 进行演示和解读。 <br> - **Shapiro-Wilk 检验:** <br>   - 零假设 ($H_0$: 服从正态)。 <br>   - `shapiro.test(residuals(model))`。 <br>   - P 值解读 (结合 Q-Q 图)。 <br> - **演示:** 对 `mlr_model_mpg` 的残差进行检验。 | `week9_lecture.qmd` §2.2 (文字和代码块) | 强调 Q-Q 图的视觉判断优先，尤其在大样本时 |
| 65-85 分钟 | **课堂实践与讨论 (针对 `mlr_model_mpg`)** | 学生操作, 分组讨论, 教师引导 | - **任务:** 学生运行 `plot(mlr_model_mpg)` 和 `shapiro.test(residuals(mlr_model_mpg))`。 <br> - **讨论:** <br>   - `mlr_model_mpg` 的残差图显示了什么？线性性和等方差性假设满足吗？ <br>   - Q-Q 图和 Shapiro 检验结果一致吗？正态性假设满足吗？ <br> - 教师巡视，解答疑问，引导学生解读结果。 | `mlr_model_mpg` 对象 | 鼓励学生动手并表达自己的判断 |
| 85-90 分钟 | **小结与预告** | 讲授 | - 总结本节课学习的诊断工具 (残差图, Q-Q 图, Shapiro 检验)。 <br> - 预告下节课内容：多重共线性、强影响点诊断，以及更具挑战性的 `prob_model` 分析和综合实验。 | - | 确保知识点串联 |

---

## 第二节课 (90 分钟): 进阶诊断与综合实验

**目标:** 掌握 VIF 和 Cook 距离的用法与解读，能够对模型进行全面诊断，并通过实验对比不同模型的诊断结果。

**时间** | **活动/内容** | **教学方法** | **关键点/强调内容** | **对应材料/代码** | **备注/互动**
|---|---|---|---|---|---|
| 0-5 分钟 | **回顾与衔接** | 提问, 讲授 | - 快速回顾上节课的诊断工具及其用途。 <br> - 提问：除了 L.I.N.E. 假设，模型还可能有哪些问题？（引出共线性和影响点） | - | 承上启下 |
| 5-25 分钟 | **诊断工具 3: 多重共线性检查 (VIF)** | 讲授, 代码演示, 解读 | - **概念:** 自变量间高度相关。 <br> - **危害:** 系数标准误增大、估计不稳定、难以解释独立效应。 <br> - **方差膨胀因子 (VIF):** <br>   - 原理 ($1 / (1 - R_j^2)$)。 <br>   - **解读:** VIF=1 (无), VIF>5 (关注), VIF>10 (严重)。 <br> - **R 实现:** `car::vif(model)`。 <br> - **演示:** <br>   - 计算 `mlr_model_mpg` 的 VIF (解释 `displ` 和 `cyl` 可能较高的原因)。 <br>   - **重点演示 `prob_model` 的 VIF** (预期 `x1`, `x2` 会很高，验证模拟数据的设定)。 | `week9_lecture.qmd` §2.3 (文字和代码块) | 强调 VIF 的解读标准和共线性的实际影响 |
| 25-45 分钟 | **诊断工具 4: 强影响点识别 (Cook's Distance)** | 讲授, 图形解读, 代码演示 | - **概念:** Cook's D 衡量单点对所有系数估计的整体影响。 <br> - **解读:** D 越大影响越大。经验法则 ($D_i > 4/n$, $D_i > 0.5$, $D_i > 1$)。 <br> - **R 实现:** <br>   - `plot(model)` 第四个图 (Residuals vs Leverage, Cook's D 等高线)。 <br>   - `cooks.distance(model)`。 <br>   - 可视化 Cook's D (柱状图)。 <br> - **演示:** <br>   - 对 `mlr_model_mpg` 计算并可视化 Cook's D。 <br>   - **重点演示 `prob_model` 的 Cook's D** (预期第 1 个点会很高，验证模拟数据的设定)。 | `week9_lecture.qmd` §2.4 (文字和代码块) | 结合 Residuals vs Leverage 图解释，强调阈值的选择 |
| 45-55 分钟 | **实验环节介绍与过渡** | 讲授, 说明 | - **说明:** 课堂演示使用了 `mpg` 和 `prob_model`，现在实验环节将使用**新的、不同的**数据集和模型 (`model_diamonds`, `model_complex_sim`) 来练习诊断技能。 <br> - **目的:** 让学生在不同情境下应用所学知识，培养独立分析能力。 <br> - 简要介绍 `week9_lab.qmd` 的目标和任务结构。 <br> - 确保学生已加载 `week9_lab.qmd` 中的模型代码。 | `week9_lab.qmd` §1, §2 | 清晰说明课堂与实验的区别与联系 |
| 55-80 分钟 | **综合实验 (学生独立/分组完成)** | 学生操作, 教师巡场辅导 | - **任务:** 学生按照 `week9_lab.qmd` 的指导，对 `model_diamonds` 和 `model_complex_sim` 进行完整的诊断流程： <br>   - `plot(model)` 并解读 4 个图。 <br>   - `shapiro.test()`。 <br>   - `vif()` (注意 `model_diamonds` 中因子变量的 GVIF 解读)。 <br>   - `cooks.distance()`。 <br> - **重点:** <br>   - **独立完成**诊断步骤。 <br>   - **解读**每个诊断结果。 <br>   - **对比**两个模型的诊断差异，思考原因 (`model_complex_sim` 预期会暴露非线性和异方差问题)。 | `week9_lab.qmd` §3-§6 | 鼓励学生记录发现，遇到问题及时提问 |
| 80-85 分钟 | **实验结果讨论与分享** | 提问, 学生分享, 教师点评 | - 随机抽取学生或小组分享他们对 `model_complex_sim` 的诊断结果。 <br> - 提问： <br>   - `model_complex_sim` 的残差图和 Q-Q 图与 `model_diamonds` 有何不同？说明了什么？ <br>   - VIF 和 Cook's D 的结果如何？ <br> - 教师总结关键发现，纠正错误解读。 | 学生实验结果 | 促进同伴学习，检验学习效果 |
| 85-90 分钟 | **本周总结与展望** | 讲授 | - **梳理:** 再次强调本周学习的所有诊断工具及其适用场景。 <br> - **讨论:** 模型诊断发现问题后，下一步该怎么办？（引出下周“模型修正与选择”的主题）。 <br> - 布置可能的课后思考题或阅读材料。 | `week9_lecture.qmd` §4 | 强化知识体系，激发后续学习兴趣 |

---

**教师注意事项:**

*   **课前准备:** 确保 R 环境、所需包、课件和实验文件都准备就绪。预跑一遍所有代码。
*   **时间管理:** 严格控制各环节时间，特别是理论讲解部分，为学生实践和讨论留足时间。
*   **代码演示:** 清晰展示 R 代码的输入和输出，并同步进行解读。
*   **图形解读:** 这是本周的重点和难点，要反复强调如何从图形模式判断模型问题。多使用对比（理想 vs. 现实，模型 A vs. 模型 B）。
*   **鼓励互动:** 多提问，鼓励学生分享自己的理解和遇到的问题。
*   **区分课堂与实验:** 向学生清晰解释为何课堂演示模型与实验模型不同，强调这是为了更好地练习和迁移知识。