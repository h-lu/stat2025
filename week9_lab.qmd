---
title: "第九周实验：回归模型诊断实践"
author: "Your Name / TA Name"
format:
  html:
    toc: true
    code-fold: true
    code-tools: true
editor: visual
---

## 1. 目标

本实验旨在通过实践操作，熟练掌握诊断线性回归模型（特别是多元线性回归）的常用方法，识别模型是否违反关键假设以及是否存在异常或强影响点。

-   使用 `plot()` 函数生成默认的回归诊断图。
-   解读**残差图 (Residuals vs Fitted)**，检查线性性和等方差性。
-   解读**正态 Q-Q 图 (Normal Q-Q Plot)**，检查残差正态性。
-   (可选) 解读**标度-位置图 (Scale-Location Plot)**，进一步检查等方差性。
-   (可选) 解读**残差与杠杆图 (Residuals vs Leverage Plot)**，识别高杠杆点和强影响点。
-   使用 `shapiro.test()` 对残差进行正态性检验。
-   使用 `car::vif()` 计算方差膨胀因子，诊断多重共线性。
-   使用 `cooks.distance()` 计算 Cook 距离，识别强影响点。

## 2. 数据与模型准备

我们将继续使用上周拟合的两个模型： \* `mlr_hwy`: 基于 `mpg` 数据集，`hwy ~ displ + cyl + drv`。 \* `prob_model`: 基于模拟的 `prob_data`，`y ~ x1 + x2 + x3`，包含已知问题（共线性、异常点）。

```{r setup-data-w9}
library(tidyverse)
library(ggplot2)
library(car)    # For vif() and leveneTest() if needed
library(broom)  # For augment()

# --- 模型 1: mpg 数据 ---
# mpg 数据集已在 tidyverse 中
mlr_hwy <- lm(hwy ~ displ + cyl + drv, data = mpg)
# summary(mlr_hwy) # 回顾模型

# --- 模型 2: 问题数据 ---
set.seed(42)
n_prob <- 100
x1_prob <- rnorm(n_prob)
x2_prob <- x1_prob * 0.8 + rnorm(n_prob, 0, 0.1) # 共线性
x3_prob <- rnorm(n_prob)
y_prob <- 2 + 3*x1_prob + 1*x2_prob - 2*x3_prob + rnorm(n_prob, 0, 2)
y_prob[1] <- y_prob[1] + 15 # 异常/强影响点
x1_prob[2] <- x1_prob[2] + 4 # 高杠杆点
prob_data <- tibble(y = y_prob, x1 = x1_prob, x2 = x2_prob, x3 = x3_prob)
prob_model <- lm(y ~ x1 + x2 + x3, data = prob_data)
# summary(prob_model) # 回顾模型
```

## 3. 使用 `plot(model)` 进行图形诊断

`plot()` 函数作用于 `lm` 对象时，会默认生成一系列有用的诊断图。

**任务:** 1. 对 `mlr_hwy` 模型使用 `plot()` 函数。观察生成的 4 个主要图形。 2. **解读第一个图 (Residuals vs Fitted):** \* 红线是否大致水平接近 0？ \* 点的散布是否随机，没有明显模式（如曲线、喇叭形）？ \* 这表明线性性和等方差性假设是否大致满足？ 3. **解读第二个图 (Normal Q-Q):** \* 点是否大致落在虚线（对角线）上？ \* 尾部是否有系统性偏离？ \* 这表明残差正态性假设是否大致满足？ 4. **解读第三个图 (Scale-Location):** \* 纵轴是标准化残差的平方根 ($\sqrt{|Standardized Residuals|}$)。 \* 红线是否大致水平？ \* 这进一步检查了等方差性假设。如果红线有明显上升或下降趋势，提示异方差。 5. **解读第四个图 (Residuals vs Leverage):** \* 横轴是杠杆值 (Leverage)，衡量 X 值的极端程度。 \* 纵轴是标准化残差。 \* 图中会用等高线标出 Cook's distance 的阈值（如 0.5, 1）。 \* 观察是否有同时具有高杠杆值和高残差的点（通常在右上角或右下角）？这些点可能是强影响点。是否有 Cook's D 很大的点？ 6. 对 `prob_model` 模型重复步骤 1-5，并比较其诊断图与 `mlr_hwy` 的差异，特别是观察我们已知的问题（共线性不直接体现在这些图中，但异常点/杠杆点可能显现）。

```{r practice-plot-model}
# 1. 对 mlr_hwy 进行诊断绘图
par(mfrow = c(2, 2)) # 设置 2x2 绘图区域
plot(mlr_hwy)
par(mfrow = c(1, 1)) # 恢复默认

# 2. 解读 Residuals vs Fitted (mlr_hwy):
print("--- mlr_hwy: Residuals vs Fitted 解读 ---")
print("红线略有弯曲，不是完全水平，提示可能存在轻微的非线性或异方差。")
print("点的散布宽度在拟合值较大时似乎略有增加，可能轻微违反等方差。")

# 3. 解读 Normal Q-Q (mlr_hwy):
print("--- mlr_hwy: Normal Q-Q 解读 ---")
print("大部分点落在直线上，但两端（特别是右尾）略有偏离，提示残差可能比正态分布的尾部更“重”一点。")
print("但对于大样本量，这种偏离可能不严重。")

# 4. 解读 Scale-Location (mlr_hwy):
print("--- mlr_hwy: Scale-Location 解读 ---")
print("红线略有上升趋势，再次提示可能存在轻微的异方差（方差随拟合值增大而增大）。")

# 5. 解读 Residuals vs Leverage (mlr_hwy):
print("--- mlr_hwy: Residuals vs Leverage 解读 ---")
print("大部分点的杠杆值较低。有少数点杠杆值稍高，但残差不大。")
print("没有明显的点落在 Cook's D 轮廓线之外，提示可能没有特别强的单一影响点。")

# 6. 对 prob_model 进行诊断绘图并比较
par(mfrow = c(2, 2))
plot(prob_model)
par(mfrow = c(1, 1))

print("--- prob_model: 诊断图解读 ---")
print("Residuals vs Fitted: 红线可能因异常点(点1)而弯曲，点 1 可能远离其他点。")
print("Normal Q-Q: 点 1 可能严重偏离直线。")
print("Scale-Location: 点 1 可能位置很高，红线可能受其影响。")
print("Residuals vs Leverage: 点 1 可能残差和 Cook's D 都很大（强影响点）。点 2 可能杠杆值很高，但残差不一定大。")

```

## 4. 残差正态性检验 (`shapiro.test`)

**任务:** 1. 提取 `mlr_hwy` 模型的残差。 2. 对这些残差进行 Shapiro-Wilk 正态性检验。 3. 根据 P 值和 $\alpha = 0.05$ 判断是否拒绝正态性假设。结合 Q-Q 图的观察，做出综合判断。 4. 对 `prob_model` 的残差重复步骤 1-3。

```{r practice-shapiro}
# 1. 提取 mlr_hwy 残差
residuals_hwy <- residuals(mlr_hwy)

# 2. 对 mlr_hwy 残差进行 Shapiro-Wilk 检验
shapiro_hwy <- shapiro.test(residuals_hwy)
print("Shapiro-Wilk Test for mlr_hwy residuals:")
print(shapiro_hwy)

# 3. 解读 mlr_hwy 结果
print("mlr_hwy 残差正态性解读:")
if (shapiro_hwy$p.value < 0.05) {
  print("Shapiro-Wilk 检验 P 值小于 0.05，拒绝正态性假设。")
  print("结合 Q-Q 图，虽然检验显著，但大样本下轻微偏离可能不严重影响结果。")
} else {
  print("Shapiro-Wilk 检验 P 值大于 0.05，未能拒绝正态性假设。")
}


# 4. 对 prob_model 残差进行检验
residuals_prob <- residuals(prob_model)
shapiro_prob <- shapiro.test(residuals_prob)
print("Shapiro-Wilk Test for prob_model residuals:")
print(shapiro_prob)
print("prob_model 残差正态性解读:")
if (shapiro_prob$p.value < 0.05) {
  print("Shapiro-Wilk 检验 P 值小于 0.05，拒绝正态性假设。这可能是由异常点引起的。")
} else {
  print("Shapiro-Wilk 检验 P 值大于 0.05，未能拒绝正态性假设。")
}
```

## 5. 多重共线性诊断 (`vif`)

**任务:** 1. 使用 `car::vif()` 函数计算 `mlr_hwy` 模型中自变量的方差膨胀因子。 2. 解读 VIF 值。是否存在 VIF \> 5 或 \> 10 的情况？这说明了什么？ 3. 对 `prob_model` 模型重复步骤 1-2。比较结果，验证我们已知的问题。

```{r practice-vif}
# 1. 计算 mlr_hwy 的 VIF
print("--- VIF for mlr_hwy ---")
vif_hwy <- vif(mlr_hwy)
print(vif_hwy)

# 2. 解读 mlr_hwy VIF
print("mlr_hwy VIF 解读:")
print("displ 和 cyl 的 VIF 可能较高（例如 > 5），因为排量和气缸数通常高度相关。")
print("这提示模型中存在一定的共线性，解释这两个变量的独立效应时需注意。")
print("drv 的 VIF 通常较低。")


# 3. 计算 prob_model 的 VIF 并比较
print("--- VIF for prob_model ---")
vif_prob <- vif(prob_model)
print(vif_prob)
print("prob_model VIF 解读:")
print("x1 和 x2 的 VIF 应该非常高（远大于 10），因为我们故意让它们高度相关。")
print("这证实了 prob_model 中存在严重的共线性问题。")

```

## 6. 强影响点诊断 (`cooks.distance`)

**任务:** 1. 使用 `cooks.distance()` 计算 `mlr_hwy` 模型中每个观测点的 Cook 距离。 2. 确定一个阈值（如 $4/n$）。找出 Cook 距离大于该阈值的点的索引。这些点是潜在的强影响点吗？ 3. 对 `prob_model` 模型重复步骤 1-2。我们预期哪个点的 Cook 距离会特别大？结果是否符合预期？

```{r practice-cooks-distance}
# 1. 计算 mlr_hwy 的 Cook's D
cooks_hwy <- cooks.distance(mlr_hwy)

# 2. 找出 mlr_hwy 的潜在影响点
n_hwy <- nrow(mpg)
cutoff_hwy <- 4 / n_hwy
influential_hwy_indices <- which(cooks_hwy > cutoff_hwy)
print(paste("Potential influential points in mlr_hwy (indices, cutoff=", round(cutoff_hwy, 4), "):"))
# print(influential_hwy_indices) # 输出可能较长
print(paste("Number of potential influential points in mlr_hwy:", length(influential_hwy_indices)))
print(paste("Max Cook's D in mlr_hwy:", round(max(cooks_hwy), 3)))
print("解读：可能有一些点超过阈值，但最大值可能不大，需要结合 Residuals vs Leverage 图判断。")


# 可视化 Cook's D
# plot(mlr_hwy, which = 4) # Cook's distance plot
# 或者
augment(mlr_hwy) %>%
  mutate(obs_index = row_number()) %>%
  ggplot(aes(x = obs_index, y = .cooksd)) +
  geom_col(fill = "skyblue", width = 0.7) +
  geom_hline(yintercept = cutoff_hwy, color = "red", linetype = "dashed") +
  labs(title = "Cook's Distance Plot (mlr_hwy)", x = "Observation Index", y = "Cook's Distance") +
  theme_minimal()


# 3. 对 prob_model 进行 Cook's D 分析
cooks_prob <- cooks.distance(prob_model)
n_prob <- nrow(prob_data)
cutoff_prob <- 4 / n_prob
influential_prob_indices <- which(cooks_prob > cutoff_prob)
print(paste("Potential influential points in prob_model (indices, cutoff=", round(cutoff_prob, 4), "):"))
print(influential_prob_indices)
print(paste("Max Cook's D in prob_model:", round(max(cooks_prob), 3)))
print("解读：预期点 1 的 Cook's D 会很大。检查点 1 是否在索引中，并且其值是否远超其他点。")


# 查看 Cook's D 值
# print("Cook's D for prob_model:")
# print(round(cooks_prob, 3))
# 观察第一个值是否特别大

# plot(prob_model, which = 4) # Cook's distance plot for prob_model
augment(prob_model) %>%
  mutate(obs_index = row_number()) %>%
  ggplot(aes(x = obs_index, y = .cooksd)) +
  geom_col(fill = "salmon", width = 0.7) +
  geom_hline(yintercept = cutoff_prob, color = "red", linetype = "dashed") +
  geom_hline(yintercept = 0.5, color = "blue", linetype = "dotted") +
  geom_hline(yintercept = 1, color = "darkgreen", linetype = "dotted") +
  labs(title = "Cook's Distance Plot (prob_model)", x = "Observation Index", y = "Cook's Distance") +
  theme_minimal()

```

## 7. 实验总结

在本实验中，我们系统地实践了线性回归模型诊断的常用工具。通过解读 `plot(model)` 生成的诊断图，我们评估了模型的线性性、等方差性和残差正态性假设。我们还使用 `shapiro.test()` 对正态性进行了检验。利用 `vif()`，我们诊断了模型中是否存在多重共线性问题。最后，通过计算 `cooks.distance()`，我们识别了潜在的强影响点。掌握这些诊断技能对于评估模型可靠性、发现潜在问题并为下一步的模型改进奠定基础至关重要。