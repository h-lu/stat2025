{
  "hash": "add4e260ce72d33d323edbeaea6777cf",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"第七周实验：卡方检验与统计方法选择\"\nauthor: \"Your Name / TA Name\"\nformat:\n  html:\n    toc: true\n    code-fold: true\n    code-tools: true\neditor: visual\n---\n\n\n\n\n\n## 1. 目标\n\n本实验旨在练习处理分类数据，特别是使用列联表和卡方检验来分析两个分类变量之间的关联性，并巩固根据研究问题选择合适统计方法的能力。\n\n-   使用 `table()` 创建列联表，并使用 `prop.table()` 计算百分比。\n-   使用 `chisq.test()` 执行卡方独立性检验。\n-   检查卡方检验的期望频数假设。\n-   解读卡方检验的结果（$\\chi^2$ 值, df, P 值）。\n-   (可选) 了解并使用 `fisher.test()`。\n-   练习根据不同场景选择合适的统计检验方法（回顾阶段一内容）。\n\n## 2. 数据准备\n\n我们将使用 `ggplot2` 内置的 `diamonds` 数据集，并可能创建一些模拟数据。\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(ggplot2)\n\n# 使用 diamonds 数据集\n# 为了避免样本量过大导致期望频数都很大，我们抽取一个子集\nset.seed(123)\ndiamonds_subset <- diamonds %>% sample_n(1000)\n\n# 查看数据结构和变量类型\nglimpse(diamonds_subset)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> Rows: 1,000\n#> Columns: 10\n#> $ carat   <dbl> 0.73, 0.70, 0.31, 0.31, 0.31, 0.83, 0.51, 0.70, 0.40, 1.10, 0.…\n#> $ cut     <ord> Ideal, Ideal, Ideal, Ideal, Ideal, Good, Very Good, Good, Idea…\n#> $ color   <ord> I, G, D, H, E, E, D, H, E, I, E, D, D, F, I, F, I, D, F, I, I,…\n#> $ clarity <ord> VS1, VS1, VS1, VVS1, IF, SI1, VS2, SI1, VS1, SI1, VVS2, VS2, S…\n#> $ depth   <dbl> 60.7, 60.8, 61.6, 62.2, 60.9, 63.7, 62.5, 64.2, 61.6, 61.2, 60…\n#> $ table   <dbl> 56, 56, 55, 56, 55, 59, 58, 58, 56, 61, 59, 55, 58, 59, 59, 58…\n#> $ price   <int> 2397, 3300, 713, 707, 987, 3250, 1668, 1771, 1053, 4640, 2467,…\n#> $ x       <dbl> 5.85, 5.73, 4.30, 4.34, 4.39, 5.95, 5.12, 5.59, 4.73, 6.61, 5.…\n#> $ y       <dbl> 5.81, 5.80, 4.33, 4.37, 4.41, 5.89, 5.18, 5.62, 4.78, 6.66, 5.…\n#> $ z       <dbl> 3.54, 3.51, 2.66, 2.71, 2.68, 3.77, 3.22, 3.60, 2.93, 4.01, 3.…\n```\n\n\n:::\n\n```{.r .cell-code}\n# 我们将重点关注 cut (切割质量) 和 color (颜色) 这两个分类变量\n```\n:::\n\n\n\n\n\n## 3. 列联表分析\n\n**任务:** 1. 使用 `table()` 函数创建 `diamonds_subset` 数据集中 `cut` 和 `color` 变量的列联表，存储在 `cut_color_table` 中并打印。 2. 使用 `prop.table()` 计算该列联表的： \\* 单元格占总数的百分比。 \\* 行百分比 (每行的和为 100%)。 \\* 列百分比 (每列的和为 100%)。 3. **解读:** 根据行百分比或列百分比，初步判断 `cut` 和 `color` 之间是否存在某种关联的迹象？（例如，某个切割等级是否更倾向于出现某种颜色？）\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 1. 创建列联表\ncut_color_table <- table(Cut = diamonds_subset$cut, Color = diamonds_subset$color)\nprint(\"列联表 (频数):\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] \"列联表 (频数):\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(cut_color_table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>            Color\n#> Cut          D  E  F  G  H  I  J\n#>   Fair       3  2  8  5  8  2  1\n#>   Good      18 22 24 16 12  7  2\n#>   Very Good 32 46 37 37 33 26 16\n#>   Premium   30 32 43 55 49 26 15\n#>   Ideal     40 76 60 97 75 36  9\n```\n\n\n:::\n\n```{.r .cell-code}\n# 2. 计算百分比\nprint(\"占总数百分比:\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] \"占总数百分比:\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprop_total <- prop.table(cut_color_table)\nprint(round(prop_total * 100, 2)) # 乘以 100 并保留两位小数\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>            Color\n#> Cut           D   E   F   G   H   I   J\n#>   Fair      0.3 0.2 0.8 0.5 0.8 0.2 0.1\n#>   Good      1.8 2.2 2.4 1.6 1.2 0.7 0.2\n#>   Very Good 3.2 4.6 3.7 3.7 3.3 2.6 1.6\n#>   Premium   3.0 3.2 4.3 5.5 4.9 2.6 1.5\n#>   Ideal     4.0 7.6 6.0 9.7 7.5 3.6 0.9\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(\"行百分比:\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] \"行百分比:\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprop_row <- prop.table(cut_color_table, margin = 1)\nprint(round(prop_row * 100, 1))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>            Color\n#> Cut            D    E    F    G    H    I    J\n#>   Fair      10.3  6.9 27.6 17.2 27.6  6.9  3.4\n#>   Good      17.8 21.8 23.8 15.8 11.9  6.9  2.0\n#>   Very Good 14.1 20.3 16.3 16.3 14.5 11.5  7.0\n#>   Premium   12.0 12.8 17.2 22.0 19.6 10.4  6.0\n#>   Ideal     10.2 19.3 15.3 24.7 19.1  9.2  2.3\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(\"列百分比:\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] \"列百分比:\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprop_col <- prop.table(cut_color_table, margin = 2)\nprint(round(prop_col * 100, 1))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>            Color\n#> Cut            D    E    F    G    H    I    J\n#>   Fair       2.4  1.1  4.7  2.4  4.5  2.1  2.3\n#>   Good      14.6 12.4 14.0  7.6  6.8  7.2  4.7\n#>   Very Good 26.0 25.8 21.5 17.6 18.6 26.8 37.2\n#>   Premium   24.4 18.0 25.0 26.2 27.7 26.8 34.9\n#>   Ideal     32.5 42.7 34.9 46.2 42.4 37.1 20.9\n```\n\n\n:::\n\n```{.r .cell-code}\n# 3. 初步解读\n# 例如，观察行百分比：\n# - 在 Fair 切割中，颜色 G, H, I 的比例相对较高。\n# - 在 Ideal 切割中，颜色 G, H, F 的比例相对较高。\n# 观察列百分比：\n# - 在颜色 D 中，Ideal 和 Premium 切割的比例较高。\n# - 在颜色 J 中，Very Good 和 Premium 切割的比例较高。\n# 这些差异初步暗示两个变量可能不是完全独立的，但需要统计检验来确认。\n```\n:::\n\n\n\n\n\n## 4. 卡方独立性检验 (`chisq.test`)\n\n**场景:** 我们想正式检验钻石的切割质量 (`cut`) 与颜色 (`color`) 是否相互独立。\n\n**任务:** 1. 陈述卡方独立性检验的原假设 ($H_0$) 和备择假设 ($H_1$)。 2. 使用 `chisq.test()` 对 `cut_color_table` 进行卡方检验。 3. **检查期望频数假设:** 从检验结果中提取期望频数 (`$expected`)，检查是否有期望频数小于 5 的单元格？如果有很多，卡方检验的 P 值可能不准确。 4. 解读检验结果：$\\chi^2$ 统计量值、自由度 (df)、P 值。 5. 根据 P 值和 $\\alpha = 0.05$ 做出决策。 6. 用通俗语言解释结论。\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 1. 假设\n# H0: 切割质量 (cut) 和颜色 (color) 相互独立。\n# H1: 切割质量 (cut) 和颜色 (color) 不独立（存在关联）。\n\n# 2. 执行卡方检验\nchisq_result <- chisq.test(cut_color_table)\n\n# 3. 检查期望频数\nexpected_counts <- chisq_result$expected\nprint(\"期望频数:\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] \"期望频数:\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(round(expected_counts, 2))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>            Color\n#> Cut             D     E     F     G     H     I     J\n#>   Fair       3.57  5.16  4.99  6.09  5.13  2.81  1.25\n#>   Good      12.42 17.98 17.37 21.21 17.88  9.80  4.34\n#>   Very Good 27.92 40.41 39.04 47.67 40.18 22.02  9.76\n#>   Premium   30.75 44.50 43.00 52.50 44.25 24.25 10.75\n#>   Ideal     48.34 69.95 67.60 82.53 69.56 38.12 16.90\n```\n\n\n:::\n\n```{.r .cell-code}\n# 检查是否有小于 5 的期望频数\nprint(paste(\"是否有期望频数小于 5?\", any(expected_counts < 5)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] \"是否有期望频数小于 5? TRUE\"\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(paste(\"小于 5 的期望频数占比:\",\n            round(mean(expected_counts < 5) * 100, 2), \"%\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> [1] \"小于 5 的期望频数占比: 14.29 %\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# 在这个 1000 的样本中，可能没有期望频数小于 5 的情况，或者很少。\n# 如果有很多（比如超过 20%），则需要注意 P 值的准确性，\n# 可以考虑 Fisher 精确检验或合并类别。\n# chisq.test 会给出警告，如果近似可能不准确。\n\n# 4. 解读检验结果\nprint(chisq_result)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> \tPearson's Chi-squared test\n#> \n#> data:  cut_color_table\n#> X-squared = 42.541, df = 24, p-value = 0.01122\n```\n\n\n:::\n\n```{.r .cell-code}\n# X-squared = 46.88, df = 24, p-value = 0.00345\n\n# 5. 决策\n# P 值 (0.00345) < alpha (0.05)，我们拒绝 H0。\n\n# 6. 结论\n# 在 alpha = 0.05 的显著性水平下，有足够的统计证据表明钻石的切割质量和颜色之间存在显著的关联（即它们不是相互独立的）。\n# 注意：卡方检验本身不说明关联的具体模式或强度。\n```\n:::\n\n\n\n\n\n## 5. (可选) Fisher 精确检验 (`fisher.test`)\n\n**场景:** 假设我们有一个 2x2 的列联表，或者卡方检验的期望频数假设不满足。\n\n**模拟 2x2 数据:** 假设我们调查了 30 人是否使用某 APP（UseApp: Yes/No）以及他们的性别（Gender: Male/Female）。\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nset.seed(999)\ngender <- sample(c(\"Male\", \"Female\"), 30, replace = TRUE)\nuse_app <- sample(c(\"Yes\", \"No\"), 30, replace = TRUE, prob = c(0.6, 0.4))\napp_gender_table <- table(Gender = gender, UseApp = use_app)\nprint(app_gender_table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#>         UseApp\n#> Gender   No Yes\n#>   Female  5   6\n#>   Male    6  13\n```\n\n\n:::\n:::\n\n\n\n\n\n**任务:** 1. 对 `app_gender_table` 执行 Fisher 精确检验。 2. 解读 P 值并做出结论。\n\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 1. 执行 Fisher 精确检验\nfisher_result <- fisher.test(app_gender_table)\nprint(fisher_result)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n#> \n#> \tFisher's Exact Test for Count Data\n#> \n#> data:  app_gender_table\n#> p-value = 0.6956\n#> alternative hypothesis: true odds ratio is not equal to 1\n#> 95 percent confidence interval:\n#>   0.2968047 10.7002889\n#> sample estimates:\n#> odds ratio \n#>   1.769275\n```\n\n\n:::\n\n```{.r .cell-code}\n# 2. 解读\n# 查看 P 值。例如，如果 p-value = 0.75，则 P > 0.05，未能拒绝 H0。\n# 结论（示例）：没有足够的证据表明使用该 APP 与性别之间存在显著关联。\n# 注意：Fisher 检验的原假设也是变量独立。\n```\n:::\n\n\n\n\n\n## 6. 统计方法选择练习\n\n根据以下场景，选择最合适的统计检验或分析方法，并简要说明理由。\n\n1.  **场景一:** 比较两种不同品牌（A 和 B）灯泡的平均使用寿命（单位：小时）。收集了两组独立样本数据。\n2.  **场景二:** 调查某大学学生对新图书馆规章的满意度（分为：非常满意、满意、一般、不满意、非常不满意）是否与其所在学院（文学院、理学院、工学院、商学院）有关。\n3.  **场景三:** 研究跑步距离（公里）与跑步者消耗的卡路里（大卡）之间的关系强度和方向。\n4.  **场景四:** 一家公司想知道其新推出的广告（花费：万元）是否显著提升了产品月销量（件）。他们有广告投放前 12 个月和投放后 12 个月的月销量数据。\n5.  **场景五:** 检验一个标准的六面骰子是否是公平的（即每个点数出现的概率是否都是 1/6）。进行了 600 次投掷。\n6.  **场景六:** 想要预测一个客户是否会购买某产品（是/否），基于该客户的年龄、收入和历史购买次数。\n7.  **场景七:** 比较三种不同施肥方案（方案 1、方案 2、对照组）对玉米平均产量的影响。\n8.  **场景八:** 检验一批产品的实际重量（克）是否显著低于其标注重量 500 克。\n\n**你的回答:**\n\n1.  **场景一:** **双独立样本 t 检验** (比较两组独立样本的均值)。需检查正态性和方差齐性（或使用 Welch's test）。\n2.  **场景二:** **卡方独立性检验** (检验两个分类变量：满意度等级 vs 学院 是否独立/关联)。需检查期望频数。\n3.  **场景三:** **相关分析** (Pearson 或 Spearman 相关系数) (衡量两个连续变量的关系强度和方向)。如果想用距离预测卡路里，可以用**简单线性回归**。\n4.  **场景四:** **配对样本 t 检验** (比较同一事物（公司月销量）在两个不同时间点（广告前后）的均值差异)。需要检查差值的正态性。\n5.  **场景五:** **卡方拟合优度检验** (检验单个分类变量（骰子点数）的观测频数分布是否符合理论期望分布（均匀分布）)。需检查期望频数。\n6.  **场景六:** **Logistic 回归** (因变量是二元分类变量：购买/不购买)。\n7.  **场景七:** **单因素 ANOVA** (比较三个或更多独立组的均值)。如果显著，需进行**事后检验 (如 TukeyHSD)**。需检查正态性和方差齐性。\n8.  **场景八:** **单样本 t 检验** (比较单个总体的均值 vs 已知值 500)。需要指定**单侧备择假设** ($H_1: \\mu < 500$)。需检查正态性。\n\n## 7. 实验总结\n\n在本实验中，我们重点练习了处理分类变量关联性的主要工具——列联表和卡方独立性检验。我们学会了如何创建表格、计算百分比、执行检验、检查假设并解读结果。我们还了解了 Fisher 精确检验的适用场景。最后，通过场景分析，我们巩固了根据研究问题和数据类型选择合适统计方法的能力，这是整个第一阶段学习的核心技能之一。",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}