# 第九周：回归模型诊断实战 - 详细授课脚本/内容指引

**周次:** 9
**主题:** 回归模型诊断：发现模型的问题
**总时长:** 180 分钟 (2 x 90 分钟)
**核心材料:** `week9_lecture.qmd`, `week9_lab.qmd`
**所需 R 包:** `tidyverse`, `ggplot2`, `car`, `broom`

---

## 第一节课 (90 分钟): 模型诊断基础与核心图形分析

**目标:** 掌握模型诊断的基本概念，学会使用和解读残差图与正态 Q-Q 图，并了解正态性检验。

**(0-5 分钟) 课程导入与回顾**

*   **教师:** "大家下午好！上周我们一起学习了如何构建多元线性回归模型，比如用汽车的排量、气缸数和驱动方式来预测它的高速公路油耗。我们得到了模型的系数，也看到了 R²，看起来模型还不错。但是，拟合出模型就足够了吗？我们能完全相信这个模型给出的结果吗？"
*   **（稍作停顿，引导思考）**
*   **教师:** "对，仅仅拟合模型是不够的。就像医生给病人看病不仅要看表面症状，还要做各种检查一样，我们也需要对我们建立的模型进行‘体检’，这就是我们今天要学习的——**模型诊断 (Model Diagnostics)**。"

**(5-15 分钟) 为何需要模型诊断？**

*   **教师:** "为什么要诊断呢？主要有两个目的："
*   **教师:** "第一，我们要检查我们建立模型时依赖的一些基本假设是否成立。还记得线性回归的 **L.I.N.E. 假设**吗？"
    *   **L - 线性性 (Linearity):** Y 和 X 的关系真的是线性的吗？
    *   **I - 独立性 (Independence):** 误差项之间是否相互独立？（这个我们主要靠实验设计保证，诊断方法较少涉及）
    *   **N - 正态性 (Normality):** 误差项（或者说残差）是否服从正态分布？
    *   **E - 等方差性 (Equal Variance / Homoscedasticity):** 误差项的方差是否恒定，不随 X 的变化而变化？
*   **教师:** "如果这些假设不满足，我们模型的系数估计、P 值、置信区间可能就不可靠了，就像地基不稳的房子一样。"
*   **教师:** "第二，我们要识别数据中是否存在一些‘捣乱分子’，它们可能对我们的模型产生过大的影响。"
    *   **异常值 (Outliers):** Y 值特别奇怪的点，离模型的预测线很远（想象一下，大部分数据点都在一条线附近，突然有一个点跑到了天边）。
    *   **高杠杆点 (High Leverage Points):** X 值特别奇怪的点，在自变量空间里很偏僻（想象一下，大部分人的身高体重都在一个范围内，突然来了一个身高 3 米的人）。这种点有潜力（杠杆）撬动回归线。
    *   **强影响点 (Influential Points):** 那些真正对模型系数产生巨大影响的点。通常它们既是异常值，又是高杠杆点。（想象一下，那个身高 3 米的人，体重还特别轻，他一个人就能把身高体重关系线拉歪）。
*   **教师:** "所以，模型诊断就是帮助我们发现这些问题，确保我们模型结果的**可靠性 (Reliability)** 和 **有效性 (Validity)**。这周我们的目标就是掌握这些诊断工具。"
*   **（展示 `week9_lecture.qmd` §1 的目标 Callout）**

**(15-20 分钟) 准备工作与示例模型介绍**

*   **教师:** "好，在开始诊断之前，我们先做一些准备工作。请大家打开 RStudio，加载我们需要的 R 包。"
*   **（引导学生运行加载包的代码）**
    ```R
    library(tidyverse)
    library(ggplot2)
    library(car) # 如果没有安装，需要 install.packages("car")
    library(broom) # 如果没有安装，需要 install.packages("broom")
    ```
*   **教师:** "为了演示诊断过程，我们今天会用到两个模型。第一个是我们上周熟悉的，基于 `mpg` 数据集，预测高速公路油耗的模型，我们叫它 `mlr_model_mpg`。"
*   **（引导学生运行 `mlr_model_mpg` 的代码）**
    ```R
    # 回顾上周的 MLR 模型
    # mpg 数据集已在 tidyverse 中
    mlr_model_mpg <- lm(hwy ~ displ + cyl + drv, data = mpg)
    summary(mlr_model_mpg) # 可以快速看一下回顾
    ```
*   **教师:** "这个模型基于真实数据，可能相对‘健康’一些。为了更好地展示诊断工具如何发现问题，我还特意‘制造’了一个包含已知问题的数据集，并用它拟合了第二个模型，叫做 `prob_model`。这个模型里我故意加入了一些共线性和异常/影响点，我们来看看诊断工具能不能把它们揪出来。"
*   **（引导学生运行 `prob_model` 的代码）**
    ```R
    # 为了演示，创建一个包含一些潜在问题的数据集
    set.seed(42)
    n_prob <- 100
    x1_prob <- rnorm(n_prob)
    x2_prob <- x1_prob * 0.8 + rnorm(n_prob, 0, 0.1) # 引入共线性
    x3_prob <- rnorm(n_prob)
    y_prob <- 2 + 3*x1_prob + 1*x2_prob - 2*x3_prob + rnorm(n_prob, 0, 2)
    # 引入一个异常值/强影响点
    y_prob[1] <- y_prob[1] + 15
    x1_prob[2] <- x1_prob[2] + 4 # 引入一个高杠杆点
    prob_data <- tibble(y = y_prob, x1 = x1_prob, x2 = x2_prob, x3 = x3_prob)
    prob_model <- lm(y ~ x1 + x2 + x3, data = prob_data)
    summary(prob_model) # 简单看一下
    ```
*   **教师:** "注意，课堂上我们用这两个模型 (`mlr_model_mpg`, `prob_model`) 来学习诊断方法。稍后的实验环节，大家会用到另外两个不同的模型来练习。"

**(20-45 分钟) 诊断工具 1: 残差分析 (线性性与等方差性)**

*   **教师:** "模型诊断的核心武器是**残差 (Residuals)**。什么是残差？就是观测值 $y_i$ 和模型预测值 $\hat{y}_i$ 之间的差距， $e_i = y_i - \hat{y}_i$。它代表了模型未能解释的信息。"
*   **教师:** "我们最常用的诊断图之一就是**残差图 (Residuals vs Fitted Plot)**。"
    *   "看这个图，**横轴**是模型的**拟合值 (Fitted values, $\hat{y}_i$)**，也就是模型预测出来的 Y 值。"
    *   "**纵轴**就是我们刚才说的**残差 (Residuals, $e_i$)**。"
*   **教师:** "我们希望看到什么样的图形呢？**理想情况**下，这些点应该像‘天女散花’一样，**随机地散布**在中间 $y=0$ 这条水平线的上下，**没有任何明显的模式**，而且散布的**宽度**应该大致保持一致。"
*   **（展示理想残差图的示意图或例子）**
*   **教师:** "那如果图形不理想，说明什么问题呢？"
    *   "第一，检查**线性性**。如果这些点呈现出明显的**曲线模式**（比如像一个 U 形或者倒 U 形），那可能说明 Y 和某个 X 的真实关系不是线性的，我们的线性模型没有拟合好。"
    *   "第二，检查**等方差性**。如果点的散布**宽度**随着拟合值的变化而变化，比如像一个**喇叭口**（低预测值处散布窄，高预测值处散布宽）或者**扇形**，那就违反了等方差性假设，这种情况叫做**异方差 (Heteroscedasticity)**。"
*   **（展示非线性、异方差的残差图示例）**
*   **教师:** "如何在 R 中得到这个图呢？非常简单。对于一个 `lm` 模型对象，比如 `mlr_model_mpg`，直接用 `plot()` 函数就行。它默认会生成一系列诊断图，第一个就是我们需要的残差图。"
*   **（演示代码）**
    ```R
    # 方法1: 使用基础 plot() 函数 (推荐)
    # 为了能一次看到多个图，我们先设置一下绘图区域
    par(mfrow = c(2, 2)) # 把绘图区分成 2x2
    plot(mlr_model_mpg) # 运行这句，会依次弹出4个图，我们先看第一个
    par(mfrow = c(1, 1)) # 看完记得恢复默认设置
    ```
*   **教师:** "大家看第一个图 (Residuals vs Fitted)。红色的线是平滑曲线，帮助我们看趋势。这些点散布得怎么样？有没有明显的曲线？散布的宽度是不是大致均匀？（引导学生观察 `mlr_model_mpg` 的第一个图，可能看起来还不错，没有特别严重的问题）。"
*   **教师:** "我们也可以用 `ggplot2` 来画，需要先用 `broom` 包的 `augment()` 函数提取模型的诊断信息。"
*   **（演示 `ggplot2` 代码，解释 `.fitted` 和 `.resid`）**
    ```R
    # 方法2: 使用 ggplot2 (更灵活)
    mpg_diag <- augment(mlr_model_mpg) # 提取诊断信息
    # glimpse(mpg_diag) # 可以看看里面有什么

    ggplot(mpg_diag, aes(x = .fitted, y = .resid)) +
      geom_point(alpha = 0.6) +
      geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
      geom_smooth(se = FALSE, color = "blue") + # 平滑曲线辅助观察
      labs(title = "Residuals vs Fitted (mpg)", x = "Fitted values", y = "Residuals") +
      theme_minimal()
    ```
*   **教师:** "大家可以思考一下，如果我们对那个有问题的 `prob_model` 画这个图，会看到什么？（可以快速展示 `plot(prob_model, which=1)` 或对应的 ggplot 图，指出可能的异常点或模式）。"

**(45-65 分钟) 诊断工具 2: 残差正态性检查**

*   **教师:** "L.I.N.E. 假设中的 'N' 指的是残差的正态性。我们通常用**正态 Q-Q 图 (Normal Q-Q Plot)** 来检查。"
    *   "Q-Q 代表 Quantile-Quantile。这个图的**横轴**是**理论正态分布的分位数**。"
    *   "**纵轴**是我们的**样本残差（通常是标准化后的）的分位数**。"
*   **教师:** "**理想情况**下，如果残差确实来自正态分布，那么图上的点应该大致落在一条**对角线 (y=x)** 上。"
*   **（展示理想 Q-Q 图的示意图）**
*   **教师:** "如果点系统性地偏离这条直线，特别是呈现 **S 形**或者**弓形**，或者两端（尾部）偏离严重，那就提示残差可能不是正态分布的。"
*   **（展示非正态 Q-Q 图示例）**
*   **教师:** "在 R 中，`plot(model)` 生成的**第二个图**就是正态 Q-Q 图。"
*   **（重新运行 `plot(mlr_model_mpg)` 并指向第二个图）**
*   **教师:** "大家看 `mlr_model_mpg` 的 Q-Q 图。这些点是不是基本在虚线上？看起来正态性假设满足得还可以。"
*   **教师:** "同样，我们也可以用 `ggplot2` 来画。"
*   **（演示 `ggplot2` 代码，解释 `aes(sample = .std.resid)`）**
    ```R
    # 方法2: 使用 ggplot2
    ggplot(mpg_diag, aes(sample = .std.resid)) + # .std.resid 是标准化残差
      stat_qq() + # 画 Q-Q 点
      stat_qq_line(color = "red") + # 画理论直线
      labs(title = "Normal Q-Q Plot (mpg)", x = "Theoretical Quantiles", y = "Standardized Residuals") +
      theme_minimal()
    ```
*   **教师:** "除了看图，我们还可以做一个统计检验——**Shapiro-Wilk 正态性检验**。这是一个专门用来检验数据是否来自正态分布的常用方法。"
    *   "它的**零假设 ($H_0$)** 是：数据服从正态分布。"
    *   "**备择假设 ($H_1$)** 是：数据不服从正态分布。"
*   **教师:** "在 R 中，我们用 `shapiro.test()` 函数，把模型的残差传给它。"
*   **（演示代码）**
    ```R
    # 提取模型残差
    residuals_mpg <- residuals(mlr_model_mpg)
    # 执行 Shapiro-Wilk 检验
    shapiro.test(residuals_mpg)
    ```
*   **教师:** "看结果中的 **p-value**。通常我们设定一个显著性水平 $\alpha$，比如 0.05。"
    *   "如果 **P 值 > 0.05**，我们**没有足够证据拒绝零假设**，可以说残差与正态分布没有显著差异。"
    *   "如果 **P 值 < 0.05**，我们**拒绝零假设**，认为残差**不服从**正态分布。"
*   **教师:** "**重要提醒：** 对于样本量很大的数据（比如几百上千个点），即使残差只是轻微偏离正态，Shapiro 检验也可能给出非常小的 P 值（即拒绝 H0）。这时候，我们更应该相信 **Q-Q 图的视觉判断**。如果 Q-Q 图看起来基本在直线上，即使 P 值小于 0.05，我们通常也可以认为正态性假设近似满足。"
*   **教师:** "大家可以试试对 `prob_model` 的残差做检验，看看结果如何。（`shapiro.test(residuals(prob_model))`，结果 P 值可能很小，结合之前看到的 `prob_model` 的 Q-Q 图进行解释）。"

**(65-85 分钟) 课堂实践与讨论 (针对 `mlr_model_mpg`)**

*   **教师:** "好了，理论讲了不少，现在大家动手来实践一下。请大家对我们课堂上的第一个模型 `mlr_model_mpg` 进行诊断。"
*   **任务:**
    1.  运行 `par(mfrow=c(2,2)); plot(mlr_model_mpg); par(mfrow=c(1,1))`，仔细观察第一个（Residuals vs Fitted）和第二个（Normal Q-Q）图。
    2.  运行 `shapiro.test(residuals(mlr_model_mpg))`。
*   **教师:** "请大家花几分钟时间，独立或者和旁边的同学讨论一下你们的观察结果："
    *   "问题1：从残差图来看，`mlr_model_mpg` 的线性和等方差性假设满足得怎么样？有没有看到明显的曲线或者喇叭口？"
    *   "问题2：从 Q-Q 图来看，残差的正态性如何？点是不是基本在直线上？"
    *   "问题3：Shapiro 检验的 P 值是多少？这个结果和 Q-Q 图的结论是否一致？"
*   **（教师在教室巡视，观察学生操作，解答疑问，引导讨论）**
*   **（几分钟后，邀请几位同学分享他们的看法，教师进行点评和总结）**
    *   **教师总结示例:** "看起来大家对 `mlr_model_mpg` 的诊断结果比较一致。残差图显示点散布相对随机，没有特别明显的非线性或异方差问题。Q-Q 图上的点也比较贴近直线，Shapiro 检验的 P 值（可能是 > 0.05，或者即使 < 0.05 但 Q-Q 图尚可接受）也支持正态性假设基本满足。所以，从这两个方面看，`mlr_model_mpg` 的表现还不错。"

**(85-90 分钟) 小结与预告**

*   **教师:** "好，今天我们学习了模型诊断的重要性，并掌握了两个核心的图形工具——残差图和正态 Q-Q 图，以及 Shapiro 正态性检验。通过它们，我们可以初步判断模型的线性和等方差性、残差正态性假设是否满足。"
*   **教师:** "但这还不是全部。模型可能还有其他问题，比如自变量之间关系太密切（共线性），或者存在个别特别‘霸道’的数据点（强影响点）。这些问题怎么诊断呢？这就是我们下节课要学习的内容。同时，我们也会更深入地分析那个‘问题模型’`prob_model`，看看这些工具如何帮助我们发现隐藏的问题。最后，大家会进行一个综合性的实验练习。请大家回去复习一下今天的内容，我们下节课继续。"

---

## 第二节课 (90 分钟): 进阶诊断与综合实验

**目标:** 掌握 VIF 和 Cook 距离的用法与解读，能够对模型进行全面诊断，并通过实验对比不同模型的诊断结果。

**(0-5 分钟) 回顾与衔接**

*   **教师:** "大家早上/下午好！上节课我们学习了如何检查模型的线性和等方差性（通过什么图？——残差图），以及如何检查残差的正态性（通过什么图和检验？——Q-Q 图和 Shapiro 检验）。这些都是针对 L.I.N.E. 假设的。"
*   **教师:** "今天我们要继续诊断模型的另外两个常见问题：一是自变量之间是不是‘抱团’太紧密了？二是数据里有没有个别‘破坏分子’对模型影响太大了？"

**(5-25 分钟) 诊断工具 3: 多重共线性检查 (VIF)**

*   **教师:** "第一个问题叫做**多重共线性 (Multicollinearity)**。简单说，就是模型中的**自变量之间存在高度相关**关系。比如，我们想用一个人的身高和臂展去预测体重，但身高和臂展通常是高度相关的，这就是共线性。"
*   **教师:** "共线性有什么坏处呢？"
    *   "它会让模型系数的**标准误变大**，导致 P 值也变大，我们可能就**难以判断**某个自变量到底是不是真的显著了。"
    *   "系数的估计值会变得**非常不稳定**，数据稍微变一点点，系数可能就会跳动很大，甚至正负号都可能变！这样我们就**很难解释**每个自变量的独立作用了。"
    *   "**注意：** 共线性一般**不影响**模型的整体预测能力（比如 R²），主要影响我们对**系数的解释和推断**。"
*   **教师:** "如何诊断共线性呢？我们用**方差膨胀因子 (Variance Inflation Factor, VIF)**。"
    *   "VIF 衡量的是，因为某个自变量 $X_j$ 和其他自变量存在相关性，导致它的系数估计方差‘膨胀’了多少倍。"
    *   "它的计算思路是：轮流把每个 $X_j$ 当作因变量，用其他所有 X 去预测它，得到一个 $R_j^2$。$VIF_j = 1 / (1 - R_j^2)$。如果 $X_j$ 能被其他 X 很好地预测（$R_j^2$ 很大），那么 $VIF_j$ 就会很大。"
*   **教师:** "VIF 值怎么解读呢？"
    *   `VIF = 1`: 完美！这个自变量和其他自变量完全不相关。
    *   `VIF > 1`: 表明存在一定的共线性。
    *   **经验法则:**
        *   `VIF > 5`: 可能存在**较强**的共线性，需要我们**关注**一下了。
        *   `VIF > 10`: 通常认为存在**严重**的共线性，可能需要处理。
*   **教师:** "在 R 中，我们用 `car` 包里的 `vif()` 函数来计算。"
*   **（演示代码）**
    ```R
    library(car) # 确保 car 包已加载

    # 计算 mlr_model_mpg 的 VIF
    vif_mpg <- vif(mlr_model_mpg)
    print(vif_mpg)
    ```
*   **教师:** "看 `mlr_model_mpg` 的结果。`displ` (排量) 和 `cyl` (气缸数) 的 VIF 是不是比较高（可能大于 5）？这符合我们的预期，因为排量越大的车，气缸数通常也越多，它们之间本身就有较强的相关性。`drv` (驱动方式) 是个分类变量，它的 VIF 通常以广义 VIF (GVIF) 的形式给出，解读方式稍有不同，我们暂时先关注数值变量。"
*   **教师:** "现在，我们来看看那个‘问题模型’ `prob_model` 的 VIF。还记得我们创建数据时，让 `x2` 和 `x1` 强相关吗？"
*   **（演示代码）**
    ```R
    # 计算 prob_model 的 VIF
    vif_prob <- vif(prob_model)
    print(vif_prob)
    ```
*   **教师:** "大家看！`x1` 和 `x2` 的 VIF 是不是非常高（远超 10）？这准确地告诉我们，这两个变量之间存在严重的共线性，验证了我们之前的数据设定。`x3` 的 VIF 接近 1，说明它和其他变量没什么关系。"

**(25-45 分钟) 诊断工具 4: 强影响点识别 (Cook's Distance)**

*   **教师:** "接下来我们看第二个问题：数据中是否存在个别点对模型结果产生了过大的影响？我们用 **Cook 距离 (Cook's Distance, $D_i$)** 来衡量。"
*   **教师:** "Cook's D 衡量的是，如果把第 $i$ 个观测点**去掉**，模型**所有系数**的估计值会发生多大的**整体变化**。D 值越大，说明这个点的影响力越大，越像数据中的‘意见领袖’或‘搅局者’。"
*   **教师:** "Cook's D 如何解读呢？"
    *   "没有绝对的标准，但有一些常用的**经验法则**："
        *   $D_i > 4/n$ (n 是样本量): 这是一个比较宽松的标准，超过这个值就值得看一眼。
        *   $D_i > 0.5$: 可能是一个有影响力的点。
        *   $D_i > 1$: 通常被认为是**强影响点**，需要我们重点关注，分析它为什么影响这么大。
*   **教师:** "如何在 R 中找到这些点呢？"
    *   "方法一：还是用 `plot(model)`。它生成的**第四个图**（通常是 Residuals vs Leverage）可以帮助我们识别。这个图横轴是**杠杆值 (Leverage)**（衡量 X 的极端程度），纵轴是**标准化残差**（衡量 Y 的极端程度）。图上通常会有虚线画出的 **Cook's D 等高线**（比如 0.5, 1）。那些落在等高线外面的点，特别是右上角或右下角的点（高杠杆且残差大），往往是强影响点。"
    *   **（演示 `plot(mlr_model_mpg)` 的第四个图，解释坐标轴和等高线）**
    *   "方法二：直接计算每个点的 Cook's D 值，用 `cooks.distance()` 函数。"
    *   **（演示代码）**
        ```R
        # 计算 Cook's D
        cooks_mpg <- cooks.distance(mlr_model_mpg)
        cooks_prob <- cooks.distance(prob_model)

        # 设定阈值
        cutoff_mpg <- 4 / nrow(mpg)
        cutoff_prob <- 4 / nrow(prob_data)

        # 找出超过阈值的点的索引
        influential_mpg_indices <- which(cooks_mpg > cutoff_mpg)
        influential_prob_indices <- which(cooks_prob > cutoff_prob) # 也可以用 > 0.5 或 > 1

        print(paste("Influential points in mpg model (indices):", toString(influential_mpg_indices)))
        print(paste("Influential points in prob model (indices):", toString(influential_prob_indices)))

        # 查看这些点的数据 (可选)
        # mpg[influential_mpg_indices, ]
        # prob_data[influential_prob_indices, ]
        ```
    *   "方法三：可视化 Cook's D。画一个柱状图，看哪些点的 D 值特别突出。"
    *   **（演示 `ggplot2` 可视化 Cook's D 的代码，为 `mlr_model_mpg` 和 `prob_model` 分别绘制）**
        ```R
        # 可视化 mpg 模型的 Cook's D
        augment(mlr_model_mpg) %>%
          mutate(obs_index = row_number()) %>%
          ggplot(aes(x = obs_index, y = .cooksd)) +
          geom_col(fill = "skyblue") +
          geom_hline(yintercept = cutoff_mpg, color = "red", linetype = "dashed") +
          labs(title = "Cook's Distance Plot (mpg)", x = "Observation Index", y = "Cook's Distance") +
          theme_minimal()

        # 可视化 prob_model 的 Cook's D
        augment(prob_model) %>%
          mutate(obs_index = row_number()) %>%
          ggplot(aes(x = obs_index, y = .cooksd)) +
          geom_col(fill = "salmon") +
          geom_hline(yintercept = cutoff_prob, color = "red", linetype = "dashed") +
          geom_hline(yintercept = 0.5, color = "blue", linetype = "dotted") + # 添加 0.5 阈值
          geom_hline(yintercept = 1, color = "darkgreen", linetype = "dotted") + # 添加 1 阈值
          labs(title = "Cook's Distance Plot (Problematic Data)", x = "Observation Index", y = "Cook's Distance") +
          theme_minimal()
        ```
*   **教师:** "大家看 `prob_model` 的 Cook's D 图。是不是有一个点的 D 值特别高，远超其他点，甚至可能超过了 0.5 或 1？（指向第一个点）。这再次验证了我们之前人为加入的那个强影响点确实被 Cook's D 成功捕捉到了！"

**(45-55 分钟) 实验环节介绍与过渡**

*   **教师:** "好了，到目前为止，我们已经学习了诊断线性回归模型常用的几种武器：残差图、Q-Q 图、Shapiro 检验、VIF 和 Cook 距离。我们通过 `mlr_model_mpg` 和 `prob_model` 这两个例子，看到了这些工具如何帮助我们评估模型的假设、发现共线性和识别影响点。"
*   **教师:** "接下来是大家的**实验时间**。在实验中，你们将**不会**再使用 `mlr_model_mpg` 和 `prob_model`。我们会用到 `week9_lab.qmd` 文件中定义的**两个全新的模型**：`model_diamonds`（基于钻石数据集）和 `model_complex_sim`（一个更复杂的模拟数据集）。"
*   **教师:** "为什么用新模型呢？目的是让大家练习将在不同数据情境下应用我们刚刚学到的诊断技能，而不是仅仅重复课堂上的例子。这能更好地锻炼大家独立分析问题的能力。"
*   **教师:** "请大家现在打开 `week9_lab.qmd` 文件。先花点时间阅读一下第一部分（目标）和第二部分（数据与模型准备），确保你们理解这两个新模型是什么，并且运行第二部分的代码，把 `model_diamonds` 和 `model_complex_sim` 这两个模型对象创建在你们的 R 环境里。"
*   **（给学生几分钟时间阅读和运行代码，巡视确保模型已生成）**

**(55-80 分钟) 综合实验 (学生独立/分组完成)**

*   **教师:** "好，模型都准备好了吗？现在请大家按照 `week9_lab.qmd` 文件中第 3 到第 6 部分的任务指引，一步一步地对 `model_diamonds` 和 `model_complex_sim` 这两个模型进行完整的诊断。"
*   **任务要点:**
    1.  对每个模型运行 `plot(model)`，仔细解读输出的 4 个核心诊断图（Residuals vs Fitted, Normal Q-Q, Scale-Location, Residuals vs Leverage）。
    2.  对每个模型的残差运行 `shapiro.test()`。
    3.  对每个模型运行 `vif()`。特别注意 `model_diamonds` 包含分类变量，需要关注 GVIF 的解读（提示：看 `GVIF^(1/(2*Df))`）。
    4.  对每个模型运行 `cooks.distance()`，并判断是否存在强影响点（比如用 $4/n$ 作为阈值）。
*   **教师:** "在做的过程中，请大家特别注意：**不仅仅是运行代码，更重要的是解读结果！**"
    *   "对于 `model_diamonds`（真实数据），它的诊断结果怎么样？哪些假设看起来满足得比较好，哪些可能有问题？"
    *   "对于 `model_complex_sim`（我们知道它包含非线性和异方差），诊断图能不能反映出这些问题？它的残差图、Q-Q 图和 `model_diamonds` 比起来有什么显著不同？"
    *   "两个模型的 VIF 和 Cook's D 结果又说明了什么？"
*   **教师:** "大家可以独立完成，也可以和旁边的同学小声讨论。遇到任何问题，随时举手提问。请大家把你们的发现和解读简单记录下来。"
*   **（教师在教室巡视，提供个别指导，解答 R 代码或概念上的疑问，引导学生思考对比）**

**(80-85 分钟) 实验结果讨论与分享**

*   **教师:** "时间差不多了，我们一起来看看大家的发现。有没有哪位同学愿意分享一下，你对 `model_complex_sim` 这个模型的诊断结果？比如，它的残差图 (Residuals vs Fitted) 长什么样？和 `model_diamonds` 的比起来，有什么不一样？"
*   **（邀请 1-2 位学生分享他们的观察，比如可能观察到曲线模式或喇叭口）**
*   **教师:** "很好。那 `model_complex_sim` 的 Q-Q 图呢？正态性看起来如何？Shapiro 检验的结果呢？"
*   **（邀请学生分享，可能观察到偏离直线，P 值很小）**
*   **教师:** "VIF 和 Cook's D 呢？有没有发现什么特别的地方？"
*   **（邀请学生分享）**
*   **教师点评总结:** "非常好。通过大家的分享和实验，我们应该能看到，对于 `model_complex_sim`，由于我们模拟时加入了非线性和异方差，它的残差图很可能不再是随机散点，Q-Q 图也可能偏离直线。这恰恰说明了诊断工具的有效性！对比相对‘健康’或问题不同的 `model_diamonds`，更能体会到不同诊断图形态所指示的问题。"

**(85-90 分钟) 本周总结与展望**

*   **教师:** "我们来总结一下本周的内容。我们学习了为什么要进行模型诊断，以及一套常用的诊断‘组合拳’：通过**残差图**检查线性和等方差性，通过**Q-Q 图**和 **Shapiro 检验**检查残差正态性，通过 **VIF** 检查多重共线性，通过 **Cook 距离**和**残差杠杆图**识别强影响点。"
*   **教师:** "掌握这些工具，就像给我们的模型配上了一双‘火眼金睛’，能帮助我们发现潜在的问题，评估模型结果的可靠性。"
*   **教师:** "那么，最关键的问题来了：诊断出问题之后，我们该怎么办呢？模型有非线性怎么办？有异方差怎么办？有共线性或强影响点怎么办？能修正吗？需不需要换模型？"
*   **教师:** "这些问题的答案，就是我们下周要探讨的主题——**模型修正与选择**。我们将学习如何应对诊断中发现的各种问题，以及如何在多个可能的模型中做出选择。请大家期待下周的内容！"
*   **教师:** "今天的课就到这里，大家辛苦了！记得保存好你们的实验代码和结果。"

---

**给教师的额外提示:**

*   **语速与节奏:** 注意控制语速，给学生留出理解和反应的时间。在演示代码和解读图形时可以适当放慢。
*   **板书/PPT:** 可以将关键概念、诊断工具名称、解读要点、R 函数等写在板书或 PPT 上，方便学生记录。
*   **常见问题:** 学生可能会在 R 代码报错、图形解读、阈值选择等方面遇到困难，提前准备好对策。
*   **强调“为什么”:** 不仅要教“怎么做”，更要解释“为什么这么做”，帮助学生理解诊断的逻辑。
*   **保持积极:** 诊断出问题不是坏事，是改进模型的开始，要向学生传达这种积极的态度。